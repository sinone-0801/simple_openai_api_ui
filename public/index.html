<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>OpenAI API UI</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #1a1a1a;
            color: #e0e0e0;
            height: 100vh; /* „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ */
            height: 100dvh; /* ÂãïÁöÑ„Å™„Éì„É•„Éº„Éù„Éº„ÉàÈ´ò„ÅïÔºà„É¢„Éê„Ç§„É´„ÅÆUI„ÇíËÄÉÊÖÆÔºâ */
            overflow: hidden;
            display: flex;
            padding-top: env(safe-area-inset-top);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }

        .container {
            display: flex;
            flex: 1;
            height: 100%;
            width: 100%;
            overflow: hidden;
            position: relative;
        }

        .sidebar {
            width: 280px;
            background: #2a2a2a;
            border-right: 1px solid #3a3a3a;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            z-index: 15;
        }

        .sidebar-close-btn {
            display: none;
            position: absolute;
            top: 12px;
            right: 12px;
            background: transparent;
            border: none;
            color: #e0e0e0;
            font-size: 20px;
            cursor: pointer;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #3a3a3a;
            flex-shrink: 0;
            position: relative;
        }

        .sidebar-header h1 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #fff;
        }

        .new-thread-btn {
            width: 100%;
            padding: 10px;
            background: #0066cc;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s;
        }

        .new-thread-btn:hover {
            background: #0052a3;
        }

        .token-usage-panel {
            padding: 15px;
            background: #333;
            border-radius: 6px;
            margin-top: 15px;
        }

        .token-usage-title {
            font-size: 13px;
            font-weight: 600;
            color: #aaa;
            margin-bottom: 10px;
        }

        .token-usage-item {
            margin-bottom: 12px;
        }

        .token-usage-label {
            font-size: 12px;
            color: #999;
            margin-bottom: 4px;
        }

        .token-usage-bar {
            width: 100%;
            height: 8px;
            background: #222;
            border-radius: 4px;
            overflow: hidden;
        }

        .token-usage-fill {
            height: 100%;
            background: linear-gradient(90deg, #0066cc, #00aaff);
            transition: width 0.3s ease;
        }

        .token-usage-fill.warning {
            background: linear-gradient(90deg, #ff8800, #ffaa00);
        }

        .token-usage-fill.danger {
            background: linear-gradient(90deg, #ff3333, #ff5555);
        }

        .token-usage-text {
            font-size: 11px;
            color: #aaa;
            margin-top: 4px;
            display: flex;
            justify-content: space-between;
        }

        .threads-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .thread-item {
            padding: 12px;
            margin-bottom: 4px;
            background: #333;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .thread-item:hover {
            background: #3a3a3a;
        }

        .thread-item.active {
            background: #0066cc;
        }

        .thread-item-title {
            font-weight: 500;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .thread-item-date {
            font-size: 12px;
            color: #999;
        }

        .main-content {
            display: flex;
            flex-direction: column;
            flex: 1;
            background: #1a1a1a;
            overflow: hidden;
            transition: filter 0.3s ease;
        }

        .mobile-header-toggle,
        .mobile-input-toggle {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 14px;
            border-radius: 6px;
            border: 1px solid #444;
            background: #333;
            color: #e0e0e0;
            font-size: 14px;
            cursor: pointer;
        }

        .mobile-header-toggle:active,
        .mobile-input-toggle:active {
            background: #3f3f3f;
        }

        .toggle-icon {
            font-size: 16px;
        }

        .mobile-toolbar {
            display: none;
            gap: 10px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .mobile-toggle-btn {
            flex: 1 1 auto;
            min-width: 120px;
            padding: 10px 12px;
            border-radius: 6px;
            border: 1px solid #444;
            background: #333;
            color: #e0e0e0;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .mobile-toggle-btn:active {
            background: #3f3f3f;
        }

        .chat-header {
            max-height: 85vh;
            overflow-y: auto;
            padding-right: 12px;
            padding: 20px;
            border-bottom: 1px solid #3a3a3a;
            background: #2a2a2a;
            flex-shrink: 0;
        }

        .chat-header h2 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .chat-header-content {
            display: flex;
            flex-direction: column;
            gap: 0;
        }
        
        .chat-header.collapsed .chat-header-content,
        .input-area.collapsed .input-area-content {
            display: none;
        }

        .chat-header::-webkit-scrollbar {
            width: 6px;
        }
        .chat-header::-webkit-scrollbar-track {
            background: #2a2a2a;
        }
        .chat-header::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 3px;
        }

        .model-selector {
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .model-selector label {
            font-size: 13px;
            color: #aaa;
        }

        .model-selector select {
            padding: 6px 10px;
            background: #333;
            color: #e0e0e0;
            border: 1px solid #444;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
        }

        .model-selector select:hover {
            background: #3a3a3a;
        }

        .system-prompt-header {
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .system-prompt-header label {
            font-size: 13px;
            color: #aaa;
        }

        .system-prompt-header select {
            padding: 6px 10px;
            background: #333;
            color: #e0e0e0;
            border: 1px solid #444;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
        }

        .system-prompt-header select:hover {
            background: #3a3a3a;
        }

        .system-prompt-wrapper {
            margin-top: 16px;
            background: #262626;
            border: 1px solid #3a3a3a;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            padding: 12px;
        }

        .system-prompt-wrapper.hidden {
            display: none;
        }

        .system-prompt-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .system-prompt-title {
            font-size: 14px;
            font-weight: 600;
            color: #ddd;
        }

        .system-prompt-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .system-prompt-status {
            font-size: 12px;
            color: #66c0ff;
        }

        .system-prompt-toggle {
            padding: 6px 12px;
            background: #444;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .system-prompt-toggle:hover {
            background: #555;
        }

        .system-prompt-panel {
            margin-top: 12px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .system-prompt-panel.hidden {
            display: none;
        }

        .system-prompt-textarea {
            min-height: 120px;
            font-family: monospace;
            background: #1e1e1e;
        }

        .system-prompt-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .system-prompt-section {
            background: #1f1f1f;
            border: 1px solid #333;
            border-radius: 6px;
            padding: 10px;
        }

        .system-prompt-section-title {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 6px;
            color: #aaa;
        }

        #systemPromptAutoPreview,
        #systemPromptEffectivePreview {
            max-height: 200px;
            overflow: auto;
        }

        .chat-area {
            display: flex;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
        }

        .chat-area.hidden {
            display: none;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .message {
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
        }

        .message-header {
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .message.user .message-header {
            color: #4a9eff;
        }

        .message.assistant .message-header {
            color: #00d166;
        }

        .message-content {
            padding: 12px 16px;
            border-radius: 8px;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .message.user .message-content {
            background: #2a3f5f;
            max-width: 80%;
        }

        .message.assistant .message-content {
            background: #1a3a2a;
            max-width: 90%;
        }

        .message-timestamp {
            font-size: 11px;
            color: #666;
            margin-top: 4px;
        }

        .input-area {
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            border-top: 1px solid #3a3a3a;
            background: #2a2a2a;
            flex-shrink: 0;
        }

        .input-area-content {
            width: 100%;
        }

        .input-form {
            display: flex;
            gap: 10px;
        }

        .message-input {
            flex: 1;
            padding: 12px;
            background: #333;
            border: 1px solid #444;
            border-radius: 6px;
            color: #e0e0e0;
            font-size: 14px;
            resize: none;
            min-height: 120px;
            max-height: 60vh;
            font-family: inherit;
        }

        .input-wrapper {
            position: relative;
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        .resize-handle {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 8px;
            cursor: ns-resize;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .resize-handle::before {
            content: '';
            width: 40px;
            height: 4px;
            background: #555;
            border-radius: 2px;
            transition: background 0.2s;
        }

        .resize-handle:hover::before {
            background: #0066cc;
        }

        .resize-handle:active::before {
            background: #0052a3;
        }

        .message-input:focus {
            outline: none;
            border-color: #0066cc;
        }

        .send-btn {
            padding: 12px 24px;
            background: #0066cc;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s;
            align-self: flex-end;
        }

        .send-btn:hover:not(:disabled) {
            background: #0052a3;
        }

        .send-btn:disabled {
            background: #555;
            cursor: not-allowed;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
            padding: 40px;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-state-text {
            font-size: 18px;
            color: #666;
            text-align: center;
        }

        /* „Ç¢„Éº„ÉÜ„Ç£„Éï„Ç°„ÇØ„Éà„Éë„Éç„É´ */
        .artifacts-panel {
            width: 320px;
            background: #2a2a2a;
            border-left: 1px solid #3a3a3a;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            z-index: 15;
        }

        .artifacts-close-btn {
            display: none;
            position: absolute;
            top: 12px;
            right: 12px;
            background: transparent;
            border: none;
            color: #e0e0e0;
            font-size: 20px;
            cursor: pointer;
        }

        .artifact-dropzone {
            margin-top: 12px;
            padding: 16px;
            border: 2px dashed #555;
            border-radius: 6px;
            text-align: center;
            color: #aaa;
            cursor: pointer;
            transition: border-color 0.2s, background 0.2s;
            font-size: 13px;
        }

        .artifact-dropzone.dragover {
            border-color: #00aaff;
            background: rgba(0, 170, 255, 0.1);
            color: #fff;
        }

        .artifact-dropzone.disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .artifacts-header {
            padding: 20px;
            border-bottom: 1px solid #3a3a3a;
            flex-shrink: 0;
            position: relative;
        }

        .artifacts-header h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .create-artifact-btn {
            width: 100%;
            padding: 8px;
            background: #0066cc;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: background 0.2s;
        }

        .create-artifact-btn:hover:not(:disabled) {
            background: #0052a3;
        }

        .create-artifact-btn:disabled {
            background: #444;
            cursor: not-allowed;
        }

        .artifacts-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .artifact-item {
            padding: 12px;
            margin-bottom: 8px;
            background: #333;
            border-radius: 6px;
        }

        .artifact-filename {
            font-weight: 500;
            margin-bottom: 4px;
            word-break: break-all;
        }

        .artifact-meta {
            font-size: 12px;
            color: #999;
        }

        .artifact-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .artifact-btn {
            padding: 4px 8px;
            background: #444;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
        }

        .artifact-btn:hover {
            background: #555;
        }

        /* „É¢„Éº„ÉÄ„É´ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #2a2a2a;
            padding: 24px;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-size: 14px;
            font-weight: 500;
        }

        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            padding: 10px;
            background: #333;
            border: 1px solid #444;
            border-radius: 4px;
            color: #e0e0e0;
            font-size: 14px;
            font-family: inherit;
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-input:focus,
        .form-textarea:focus,
        .form-select:focus {
            outline: none;
            border-color: #0066cc;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }

        .btn-primary {
            background: #0066cc;
            color: white;
        }

        .btn-primary:hover {
            background: #0052a3;
        }

        .btn-secondary {
            background: #444;
            color: white;
        }

        .btn-secondary:hover {
            background: #555;
        }

        .delete-thread-btn {
            margin-top: 8px;
            padding: 6px 12px;
            background: #cc0000;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .delete-thread-btn:hover {
            background: #aa0000;
        }

        .thread-delete-container {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #3a3a3a;
        }

        pre {
            background: #1a1a1a;
            padding: 12px;
            border-radius: 4px;
            overflow-x: auto;
            margin: 8px 0;
        }

        code {
            font-family: 'Courier New', Courier, monospace;
            font-size: 13px;
        }

        .markdown-heading {
            display: block;
            font-weight: 600;
            margin: 0.3em 0 0.2em;
        }

        /* markdown Êõ∏ÂºèË®≠ÂÆö */
        .markdown-heading.level-1 { font-size: 1.6em; }
        .markdown-heading.level-2 { font-size: 1.45em; }
        .markdown-heading.level-3 { font-size: 1.3em; }
        .markdown-heading.level-4 { font-size: 1.2em; }
        .markdown-heading.level-5 { font-size: 1.1em; }

        .markdown-bold {
            font-weight: 700;
        }

        .markdown-codeblock {
            display: block;
            color: #ffcc66;
            font-family: 'Courier New', Courier, monospace;
            white-space: pre-wrap;
            margin: 8px 0;
        }

        .mobile-overlay {
            display: none;
        }

        @media (max-width: 1024px) {
            body {
                flex-direction: column;
                overflow: hidden;
                height: 100vh;
            }

            .container {
                flex-direction: column;
            }

            .sidebar,
            .artifacts-panel {
                position: fixed;
                top: 0;
                bottom: 0;
                width: min(80vw, 320px);
                max-width: 100%;
                height: 100%;
                overflow-y: auto;
                box-shadow: 0 0 20px rgba(0, 0, 0, 0.4);
                background: #222;
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
            }

            .sidebar {
                left: 0;
                transform: translateX(-100%);
            }

            .artifacts-panel {
                right: 0;
                transform: translateX(100%);
            }

            body.show-left-sidebar .sidebar {
                transform: translateX(0);
            }

            body.show-right-sidebar .artifacts-panel {
                transform: translateX(0);
            }

            body.sidebar-open {
                overflow: hidden;
            }

            .mobile-overlay {
                display: block;
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.5);
                opacity: 0;
                pointer-events: none;
                transition: opacity 0.3s ease;
                z-index: 10;
            }

            body.sidebar-open .mobile-overlay {
                opacity: 1;
                pointer-events: auto;
            }

            .sidebar-close-btn,
            .artifacts-close-btn {
                display: inline-flex;
                align-items: center;
                justify-content: center;
                width: 32px;
                height: 32px;
                border-radius: 50%;
                background: rgba(0, 0, 0, 0.4);
            }

            .mobile-toolbar {
                display: flex;
            }

            .chat-header {
                max-height: unset;
                overflow: visible;
            }

            .main-content {
                height: 100vh;
            }

            body.sidebar-open .main-content {
                filter: blur(1px);
            }

            .messages-container {
                padding: 16px;
            }

            .message.user .message-content,
            .message.assistant .message-content {
                max-width: 100%;
            }

            .input-form {
                flex-direction: column;
            }

            .send-btn {
                width: 100%;
            }
        }

        @media (max-width: 600px) {
            .chat-header h2 {
                font-size: 18px;
                padding: 12px 16px;
            }

            .chat-header .mobile-header-toggle,
            .input-area .mobile-input-toggle {
                display: flex;
            }

            .chat-header .mobile-header-toggle {
                margin-bottom: 12px;
            }

            .chat-header.collapsed .mobile-header-toggle {
                margin-bottom: 0;
            }

            .input-area {
                padding: 16px;
                padding-bottom: calc(36px + env(safe-area-inset-bottom, 0px));
            }

            .input-area.collapsed {
                padding-bottom: calc(36px + env(safe-area-inset-bottom, 0px));
            }

            .message-content {
                font-size: 14px;
            }

            .mobile-toggle-btn {
                font-size: 13px;
            }

            .message-input {
                min-height: 110px;
                max-height: 50vh;
            }

            .system-prompt-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 6px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Â∑¶„Çµ„Ç§„Éâ„Éê„ÉºÔºö„Çπ„É¨„ÉÉ„Éâ‰∏ÄË¶ß -->
        <div class="sidebar" id="leftSidebar">
            <div class="sidebar-header">
                <button class="sidebar-close-btn" onclick="closeSidebars()" aria-label="„Çµ„Ç§„Éâ„Éê„Éº„ÇíÈñâ„Åò„Çã">‚úï</button>
                <h1>OpenAI API UI</h1>
                <button class="new-thread-btn" onclick="showNewThreadModal()">+ Êñ∞Ë¶è„Çπ„É¨„ÉÉ„Éâ</button>
                
                <!-- „Éà„Éº„ÇØ„É≥‰ΩøÁî®Èáè„Éë„Éç„É´ -->
                <div class="token-usage-panel">
                    <div class="token-usage-title">„Éà„Éº„ÇØ„É≥‰ΩøÁî®Èáè (24h)</div>
                    
                    <div class="token-usage-item">
                        <div class="token-usage-label">High Cost Models (1M/day)</div>
                        <div class="token-usage-bar">
                            <div id="highCostBar" class="token-usage-fill" style="width: 0%"></div>
                        </div>
                        <div class="token-usage-text">
                            <span id="highCostUsage">0</span>
                            <span id="highCostPercent">0%</span>
                        </div>
                    </div>
                    
                    <div class="token-usage-item">
                        <div class="token-usage-label">Low Cost Models (10M/day)</div>
                        <div class="token-usage-bar">
                            <div id="lowCostBar" class="token-usage-fill" style="width: 0%"></div>
                        </div>
                        <div class="token-usage-text">
                            <span id="lowCostUsage">0</span>
                            <span id="lowCostPercent">0%</span>
                        </div>
                    </div>
                </div>

                <!-- „ÇØ„É¨„Ç∏„ÉÉ„ÉàÊÆãÈ´ò„Éë„Éç„É´ -->
                <div class="token-usage-panel">
                    <div class="token-usage-title">„ÇØ„É¨„Ç∏„ÉÉ„ÉàÊÆãÈ´ò</div>
                    
                    <div class="token-usage-item">
                        <div class="token-usage-label">ÊÆã„ÇØ„É¨„Ç∏„ÉÉ„Éà</div>
                        <div class="token-usage-bar">
                            <div id="creditBar" class="token-usage-fill" style="width: 0%"></div>
                        </div>
                        <div class="token-usage-text">
                            <span id="creditAmount">0</span>
                            <span id="creditText"></span>
                        </div>
                    </div>
                </div>
            </div>
            <div id="threadsList" class="threads-list"></div>
        </div>

        <!-- „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑÔºö„ÉÅ„É£„ÉÉ„Éà -->
        <div class="main-content">
            <div class="chat-header">
                <button
                    class="mobile-header-toggle"
                    id="mobileHeaderToggle"
                    type="button"
                    onclick="toggleMobileHeader()"
                    aria-label="„ÉÅ„É£„ÉÉ„Éà„Éò„ÉÉ„ÉÄ„Éº„ÇíÈñãÈñâ"
                    aria-expanded="false"
                >
                    <span class="toggle-icon">‚ò∞</span>
                    <span class="toggle-label">„Éò„ÉÉ„ÉÄ„Éº„ÇíÈñã„Åè</span>
                </button>
                <div class="chat-header-content">
                    <div class="mobile-toolbar">
                        <button class="mobile-toggle-btn" onclick="toggleLeftSidebar()" aria-label="„Çπ„É¨„ÉÉ„Éâ„Çµ„Ç§„Éâ„Éê„Éº„ÇíÈñã„Åè">
                            <span>‚ò∞</span>
                            <span>„Çπ„É¨„ÉÉ„Éâ</span>
                        </button>
                        <button class="mobile-toggle-btn" onclick="toggleRightSidebar()" aria-label="„Ç¢„Éº„ÉÜ„Ç£„Éï„Ç°„ÇØ„Éà„Çµ„Ç§„Éâ„Éê„Éº„ÇíÈñã„Åè">
                            <span>üìÅ</span>
                            <span>„Ç¢„Éº„ÉÜ„Ç£„Éï„Ç°„ÇØ„Éà</span>
                        </button>
                    </div>
                    <h2 id="chatTitle">„Çπ„É¨„ÉÉ„Éâ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</h2>
                    <!-- „É¢„Éá„É´ÁÆ°ÁêÜ„Ç´„Éº„Éâ -->
                    <div class="model-selector" id="modelSelector" style="display: none;">
                        <label for="modelSelect">„É¢„Éá„É´:</label>
                        <select id="modelSelect" onchange="changeModel()"></select>
                    </div>
                    <!-- „Ç∑„Çπ„ÉÜ„É†„Éó„É≠„É≥„Éó„ÉàÁÆ°ÁêÜ„Ç´„Éº„Éâ -->
                    <div class="system-prompt-header">
                        <div class="system-prompt-controls">
                            <span id="systemPromptStatus" class="system-prompt-status">„Ç∑„Çπ„ÉÜ„É†„Éó„É≠„É≥„Éó„Éà Ëá™ÂãïÂêåÊúü‰∏≠</span>
                            <button class="system-prompt-toggle" onclick="toggleSystemPromptPanel()">Ë°®Á§∫/ÈùûË°®Á§∫</button>
                        </div>
                    </div>
                    <div id="systemPromptWrapper" class="system-prompt-wrapper hidden">
                        <div id="systemPromptPanel" class="system-prompt-panel">
                            <label class="form-label">„É¶„Éº„Ç∂„ÉºÁ∑®ÈõÜÂèØËÉΩ„Å™„Éô„Éº„Çπ„Éó„É≠„É≥„Éó„Éà</label>
                            <textarea id="systemPromptUserInput" class="form-textarea system-prompt-textarea" spellcheck="false"></textarea>
                            <div class="system-prompt-actions">
                                <button id="systemPromptSaveBtn" class="btn btn-primary" onclick="saveSystemPrompt()" disabled>‰øùÂ≠ò</button>
                                <button class="btn btn-secondary" onclick="refreshSystemPrompt()" disabled>ÂÜçË™≠„ÅøËæº„Åø</button>
                            </div>
                            <div class="system-prompt-section">
                                <div class="system-prompt-section-title">Ëá™ÂãïÈÄ£Êê∫„Ç¢„Éº„ÉÜ„Ç£„Éï„Ç°„ÇØ„Éà‰∏ÄË¶ß (JSON)</div>
                                <pre><code id="systemPromptAutoPreview">{}</code></pre>
                            </div>
                            <div class="system-prompt-section">
                                <div class="system-prompt-section-title">ÈÄÅ‰ø°ÊôÇ„Å´Âà©Áî®„Åï„Çå„Çã„Ç∑„Çπ„ÉÜ„É†„Éó„É≠„É≥„Éó„Éà</div>
                                <pre><code id="systemPromptEffectivePreview"></code></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="chatArea" class="chat-area hidden">
                <div id="messagesContainer" class="messages-container"></div>
                <div class="input-area">
                    <button
                        class="mobile-input-toggle"
                        id="mobileInputToggle"
                        type="button"
                        onclick="toggleMobileInput()"
                        aria-label="„É°„ÉÉ„Çª„Éº„Ç∏ÂÖ•ÂäõÊ¨Ñ„ÇíÈñãÈñâ"
                        aria-expanded="false"
                    >
                        <span class="toggle-icon">‚úâÔ∏è</span>
                        <span class="toggle-label">ÂÖ•ÂäõÊ¨Ñ„ÇíÈñã„Åè</span>
                    </button>
                    <div class="input-area-content">
                        <form class="input-form" onsubmit="sendMessage(event)">
                            <div class="input-wrapper">
                                <div class="resize-handle" id="resizeHandle"></div>
                                <textarea
                                    id="messageInput"
                                    class="message-input"
                                    placeholder="„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ... (Shift+Enter„ÅßÈÄÅ‰ø°)"
                                    onkeydown="handleInputKeydown(event)"
                                ></textarea>
                            </div>
                            <button id="sendBtn" type="submit" class="send-btn">ÈÄÅ‰ø°</button>
                        </form>
                    </div>
                </div>
            </div>

            <div id="emptyState" class="empty-state">
                <div class="empty-state-icon">üí¨</div>
                <div class="empty-state-text">
                    Êñ∞„Åó„ÅÑ„Çπ„É¨„ÉÉ„Éâ„Çí‰ΩúÊàê„Åô„Çã„Åã„ÄÅ<br>Êó¢Â≠ò„ÅÆ„Çπ„É¨„ÉÉ„Éâ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ
                </div>
            </div>
        </div>

        <div class="mobile-overlay" id="mobileOverlay" onclick="closeSidebars()"></div>

        <!-- Âè≥„Çµ„Ç§„Éâ„Éê„ÉºÔºö„Ç¢„Éº„ÉÜ„Ç£„Éï„Ç°„ÇØ„Éà -->
        <div class="artifacts-panel" id="rightSidebar">
            <div class="artifacts-header">
                <button class="artifacts-close-btn" onclick="closeSidebars()" aria-label="„Çµ„Ç§„Éâ„Éê„Éº„ÇíÈñâ„Åò„Çã">‚úï</button>
                <h3>„Ç¢„Éº„ÉÜ„Ç£„Éï„Ç°„ÇØ„Éà</h3>
                <button class="create-artifact-btn" onclick="showCreateArtifactModal()" id="createArtifactBtn" disabled>+ Êñ∞Ë¶è‰ΩúÊàê</button>
                <div id="artifactDropzone" class="artifact-dropzone">
                    <span id="artifactDropzoneLabel">„ÉÜ„Ç≠„Çπ„Éà„Éï„Ç°„Ç§„É´ÔºàUTF-8Ôºâ„ÅÆ„ÅøÂØæÂøú: „Éï„Ç°„Ç§„É´„Çí„Åì„Åì„Å´„Éâ„É≠„ÉÉ„ÉóÔºà„Åæ„Åü„ÅØ„ÇØ„É™„ÉÉ„ÇØÔºâ</span>
                    <input id="artifactFileInput" type="file" multiple hidden />
                </div>
            </div>
            <div class="artifacts-list" id="artifactsList">
                <div style="padding: 20px; text-align: center; color: #666;">Ë™≠„ÅøËæº„Åø‰∏≠...</div>
            </div>
        </div>
    </div>

    <!-- „É¢„Éº„ÉÄ„É´Áæ§ -->
    <div id="newThreadModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Êñ∞Ë¶è„Çπ„É¨„ÉÉ„Éâ‰ΩúÊàê</div>
            <form onsubmit="createThread(event)">
                <div class="form-group">
                    <label class="form-label">„Çø„Ç§„Éà„É´</label>
                    <input type="text" id="threadTitle" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">„É¢„Éá„É´</label>
                    <select id="threadModel" class="form-select"></select>
                </div>
                <div class="form-group">
                    <label class="form-label">„Ç∑„Çπ„ÉÜ„É†„Éó„É≠„É≥„Éó„Éà</label>
                    <textarea id="threadSystemPrompt" class="form-textarea">You are a helpful assistant.</textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('newThreadModal')">„Ç≠„É£„É≥„Çª„É´</button>
                    <button type="submit" class="btn btn-primary">‰ΩúÊàê</button>
                </div>
            </form>
        </div>
    </div>

    <div id="editPromptModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">„Ç∑„Çπ„ÉÜ„É†„Éó„É≠„É≥„Éó„ÉàÁ∑®ÈõÜ</div>
            <form onsubmit="updateSystemPrompt(event)">
                <div class="form-group">
                    <label class="form-label">„Ç∑„Çπ„ÉÜ„É†„Éó„É≠„É≥„Éó„Éà</label>
                    <textarea id="editSystemPrompt" class="form-textarea"></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('editPromptModal')">„Ç≠„É£„É≥„Çª„É´</button>
                    <button type="submit" class="btn btn-primary">‰øùÂ≠ò</button>
                </div>
            </form>
            <div class="thread-delete-container">
                <button class="delete-thread-btn" onclick="deleteCurrentThread()">„Åì„ÅÆ„Çπ„É¨„ÉÉ„Éâ„ÇíÂâäÈô§</button>
            </div>
        </div>
    </div>

    <div id="artifactModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header" id="artifactModalTitle">„Ç¢„Éº„ÉÜ„Ç£„Éï„Ç°„ÇØ„Éà</div>
            <div class="form-group">
                <pre><code id="artifactContent"></code></pre>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-primary" onclick="editCurrentArtifact()">Á∑®ÈõÜ</button>
                <button type="button" class="btn btn-primary" onclick="downloadCurrentArtifact()">„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal('artifactModal')">Èñâ„Åò„Çã</button>
            </div>
        </div>
    </div>

    <div id="createArtifactModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">„Ç¢„Éº„ÉÜ„Ç£„Éï„Ç°„ÇØ„Éà„Çí‰ΩúÊàê</div>
            <form onsubmit="createArtifact(event)">
                <div class="form-group">
                    <label class="form-label">„Éï„Ç°„Ç§„É´ÂêçÔºà„ÉÜ„Ç≠„Çπ„Éà„Éï„Ç°„Ç§„É´„ÅÆ„ÅøÔºâ</label>
                    <input type="text" class="form-input" id="artifactFilename" placeholder="example.js" required>
                </div>
                <div class="form-group">
                    <label class="form-label">„Ç≥„É≥„ÉÜ„É≥„ÉÑ</label>
                    <textarea class="form-textarea" id="artifactContentInput" style="min-height: 300px; font-family: monospace;" required></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Ë™¨ÊòéÔºà„Ç™„Éó„Ç∑„Éß„É≥Ôºâ</label>
                    <input type="text" class="form-input" id="artifactDescription">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('createArtifactModal')">„Ç≠„É£„É≥„Çª„É´</button>
                    <button type="submit" class="btn btn-primary">‰ΩúÊàê</button>
                </div>
            </form>
        </div>
    </div>

    <div id="editArtifactModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">„Ç¢„Éº„ÉÜ„Ç£„Éï„Ç°„ÇØ„Éà„ÇíÁ∑®ÈõÜ</div>
            <form onsubmit="saveArtifactEdit(event)">
                <div class="form-group">
                    <label class="form-label">„Éï„Ç°„Ç§„É´Âêç</label>
                    <input type="text" class="form-input" id="editArtifactFilename" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">„Ç≥„É≥„ÉÜ„É≥„ÉÑ</label>
                    <textarea class="form-textarea" id="editArtifactContent" style="min-height: 300px; font-family: monospace;" required></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Ë™¨ÊòéÔºà„Ç™„Éó„Ç∑„Éß„É≥Ôºâ</label>
                    <input type="text" class="form-input" id="editArtifactDescription">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('editArtifactModal')">„Ç≠„É£„É≥„Çª„É´</button>
                    <button type="submit" class="btn btn-primary">‰øùÂ≠ò</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ====================
        // Ë™çË®ºÊ©üËÉΩ
        // ====================
        
        // „Éà„Éº„ÇØ„É≥ÂèñÂæó
        function getAuthToken() {
            return localStorage.getItem('authToken');
        }

        // Ë™çË®º„Éò„ÉÉ„ÉÄ„Éº„ÇíÂèñÂæó
        function getAuthHeaders() {
            const token = getAuthToken();
            if (!token) {
                return {};
            }
            return {
                'Authorization': `Bearer ${token}`
            };
        }

        // Ë™çË®º‰ªò„ÅçfetchÔºàÂÖ®„Å¶„ÅÆAPI„É™„ÇØ„Ç®„Çπ„Éà„Åß‰ΩøÁî®Ôºâ
        async function authFetch(url, options = {}) {
            const authHeaders = getAuthHeaders();
            const headers = {
                ...authHeaders,
                ...(options.headers || {})
            };
            
            return fetch(url, {
                ...options,
                headers
            });
        }

        // Ë™çË®º„ÉÅ„Çß„ÉÉ„ÇØ
        async function checkAuth() {
            const token = getAuthToken();
            
            if (!token) {
                redirectToLogin();
                return false;
            }

            try {
                const response = await authFetch('./api/auth/me', {
                    headers: getAuthHeaders()
                });

                if (!response.ok) {
                    throw new Error('Authentication failed');
                }

                const data = await response.json();
                console.log('Logged in as:', data.user.user_id);
                
                // „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„ÇíË°®Á§∫Ôºà„Ç™„Éó„Ç∑„Éß„É≥Ôºâ
                updateUserInfo(data.user);
                
                return true;
            } catch (error) {
                console.error('Auth check failed:', error);
                redirectToLogin();
                return false;
            }
        }

        // „É≠„Ç∞„Ç§„É≥„Éö„Éº„Ç∏„Å´„É™„ÉÄ„Ç§„É¨„ÇØ„Éà
        function redirectToLogin() {
            const currentUrl = encodeURIComponent(window.location.pathname + window.location.search);
            window.location.href = `./login.html?return=${currentUrl}`;
        }

        // „É≠„Ç∞„Ç¢„Ç¶„Éà
        function logout() {
            if (confirm('„É≠„Ç∞„Ç¢„Ç¶„Éà„Åó„Åæ„Åô„ÅãÔºü')) {
                localStorage.removeItem('authToken');
                localStorage.removeItem('userId');
                redirectToLogin();
            }
        }

        // „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„ÇíË°®Á§∫
        function updateUserInfo(user) {
            // „Çµ„Ç§„Éâ„Éê„Éº„Éò„ÉÉ„ÉÄ„Éº„Å´„É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„ÇíËøΩÂä†
            const sidebarHeader = document.querySelector('.sidebar-header');
            if (sidebarHeader && !document.getElementById('userInfo')) {
                const userInfoDiv = document.createElement('div');
                userInfoDiv.id = 'userInfo';
                userInfoDiv.style.cssText = 'margin-top: 15px; padding: 10px; background: #333; border-radius: 6px; font-size: 12px;';
                
                userInfoDiv.innerHTML = `
                    <div style="color: #999; margin-bottom: 4px;">„É≠„Ç∞„Ç§„É≥‰∏≠</div>
                    <div style="color: #e0e0e0; font-weight: 500; margin-bottom: 8px;">${user.user_id}</div>
                    <button onclick="logout()" style="width: 100%; padding: 6px; background: #444; border: none; border-radius: 4px; color: #e0e0e0; cursor: pointer; font-size: 12px;">
                        „É≠„Ç∞„Ç¢„Ç¶„Éà
                    </button>
                `;
                
                sidebarHeader.appendChild(userInfoDiv);
            }
        }

        // 401„Ç®„É©„Éº„ÅÆ„Éè„É≥„Éâ„É™„É≥„Ç∞
        function handleUnauthorized() {
            console.warn('Unauthorized access detected');
            localStorage.removeItem('authToken');
            localStorage.removeItem('userId');
            redirectToLogin();
        }

        // „Ç∞„É≠„Éº„Éê„É´fetch„Çí„É©„ÉÉ„ÉóÔºàË™çË®º„ÅåÂøÖË¶Å„Å™API„É™„ÇØ„Ç®„Çπ„Éà„ÅÆ„ÅøÔºâ
        const originalFetch = window.fetch;
        
        // fetch„ÅÆ„É©„ÉÉ„Éë„ÉºÈñ¢Êï∞ÔºàË™çË®º„Éò„ÉÉ„ÉÄ„Éº„ÇíËá™ÂãïËøΩÂä†Ôºâ
        async function authenticatedFetch(url, options = {}) {
            const authHeaders = getAuthHeaders();
            const headers = {
                ...authHeaders,
                ...(options.headers || {})
            };

            // fetch()„Åß„ÅØ„Å™„ÅèoriginalFetch()„Çí‰ΩøÁî®
            const response = await originalFetch(url, {
                ...options,
                headers
            });

            // 401„Ç®„É©„Éº„ÅÆÂ†¥Âêà„ÅØ„É≠„Ç∞„Ç§„É≥„Éö„Éº„Ç∏„Å´„É™„ÉÄ„Ç§„É¨„ÇØ„Éà
            if (response.status === 401) {
                handleUnauthorized();
                throw new Error('Unauthorized');
            }

            return response;
        }

        // window.fetch„Çí‰∏äÊõ∏„Åç
        window.fetch = async function(url, options = {}) {
            // Áõ∏ÂØæURL„Åæ„Åü„ÅØÂêå„Åò„Ç™„É™„Ç∏„É≥„ÅÆAPI„É™„ÇØ„Ç®„Çπ„Éà„ÅÆÂ†¥Âêà„ÅØË™çË®º„Éò„ÉÉ„ÉÄ„Éº„ÇíËøΩÂä†
            if (typeof url === 'string' && (url.startsWith('./api/') || url.startsWith('/api/'))) {
                try {
                    return await authenticatedFetch(url, options);
                } catch (error) {
                    // Ë™çË®º„Ç®„É©„Éº„ÅÆÂ†¥Âêà„ÅØ„Ç®„É©„Éº„Çí„Çπ„É≠„ÉºÔºàÂëº„Å≥Âá∫„ÅóÂÅ¥„Åß„Éè„É≥„Éâ„É™„É≥„Ç∞ÂèØËÉΩ„Å´Ôºâ
                    throw error;
                }
            }
            // „Åù„Çå‰ª•Â§ñ„ÅØÈÄöÂ∏∏„ÅÆfetch
            return originalFetch(url, options);
        };

        // ====================
        // „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥Êú¨‰Ωì
        // ====================
        
        const ALLOWED_TEXT_EXTENSIONS = new Set([
            '.txt', '.md', '.markdown', '.json', '.json5', '.js', '.mjs', '.cjs', '.ts', '.tsx',
            '.jsx', '.css', '.scss', '.sass', '.less', '.html', '.htm', '.xml', '.svg', '.yml', '.yaml',
            '.csv', '.tsv', '.log', '.ini', '.cfg', '.conf', '.env', '.py', '.rb', '.go', '.java', '.kt',
            '.swift', '.c', '.h', '.hpp', '.cpp', '.cc', '.cs', '.rs', '.php', '.sql', '.sh', '.bash', '.zsh', '.ps1'
        ]);
        const DROPZONE_TEXT_DEFAULT = '„ÉÜ„Ç≠„Çπ„Éà„Éï„Ç°„Ç§„É´ÔºàUTF-8Ôºâ„ÅÆ„ÅøÂØæÂøú: „Éï„Ç°„Ç§„É´„Çí„Åì„Åì„Å´„Éâ„É≠„ÉÉ„ÉóÔºà„Åæ„Åü„ÅØ„ÇØ„É™„ÉÉ„ÇØÔºâ';
        const ALLOWED_TEXT_EXTENSIONS_MESSAGE = Array.from(ALLOWED_TEXT_EXTENSIONS).sort().join(', ');

        let currentThreadId = null;
        let availableModels = [];
        let currentArtifact = null;
        let systemPromptState = {
            user: '',
            effective: '',
            artifacts: []
        };
        let isUploadingArtifacts = false;
        let artifactDropzoneUpdater = null;
        const MOBILE_BREAKPOINT = 600;
        let isMobileViewport = null;

        function initResizeHandle() {
            const resizeHandle = document.getElementById('resizeHandle');
            const messageInput = document.getElementById('messageInput');
            if (!resizeHandle || !messageInput) return;

            let isResizing = false;
            let startY = 0;
            let startHeight = 0;

            resizeHandle.addEventListener('mousedown', (e) => {
                isResizing = true;
                startY = e.clientY;
                startHeight = messageInput.offsetHeight;
                document.body.style.cursor = 'ns-resize';
                document.body.style.userSelect = 'none';
                e.preventDefault();
            });

            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;

                // ‰∏ä„Å´„Éâ„É©„ÉÉ„Ç∞„Åô„Çã„Å®Â§ß„Åç„Åè„Å™„ÇãÔºà„Éû„Ç§„Éä„ÇπÊñπÂêëÔºâ
                const deltaY = startY - e.clientY;
                const newHeight = startHeight + deltaY;

                // min-height„Å®max-height„ÅÆÂà∂Á¥Ñ„ÇíÈÅ©Áî®
                const minHeight = 120;
                const maxHeight = window.innerHeight * 0.6;
                const constrainedHeight = Math.max(minHeight, Math.min(maxHeight, newHeight));

                messageInput.style.flex = 'none';
                messageInput.style.height = constrainedHeight + 'px';
            });

            document.addEventListener('mouseup', () => {
                if (isResizing) {
                    isResizing = false;
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                }
            });

            // „Çø„ÉÉ„ÉÅ„Éá„Éê„Ç§„ÇπÂØæÂøú
            resizeHandle.addEventListener('touchstart', (e) => {
                isResizing = true;
                startY = e.touches[0].clientY;
                startHeight = messageInput.offsetHeight;
                e.preventDefault();
            }, { passive: false });

            document.addEventListener('touchmove', (e) => {
                if (!isResizing) return;

                const deltaY = startY - e.touches[0].clientY;
                const newHeight = startHeight + deltaY;

                const minHeight = 120;
                const maxHeight = window.innerHeight * 0.6;
                const constrainedHeight = Math.max(minHeight, Math.min(maxHeight, newHeight));

                messageInput.style.flex = 'none';
                messageInput.style.height = constrainedHeight + 'px';
            }, { passive: false });

            document.addEventListener('touchend', () => {
                if (isResizing) {
                    isResizing = false;
                }
            });
        }

        async function init() {
            // Ë™çË®º„ÉÅ„Çß„ÉÉ„ÇØÔºàÊúÄÂàù„Å´ÂÆüË°åÔºâ
            const isAuthenticated = await checkAuth();
            if (!isAuthenticated) {
                return; // Ë™çË®ºÂ§±ÊïóÊôÇ„ÅØ„Åì„Åì„ÅßÁµÇ‰∫ÜÔºà„É™„ÉÄ„Ç§„É¨„ÇØ„Éà„Åï„Çå„ÇãÔºâ
            }

            await loadThreads();
            await loadModels();
            await loadTokenUsage();
            await loadCreditInfo(); // „ÇØ„É¨„Ç∏„ÉÉ„ÉàÊÉÖÂ†±„ÇíÂàùÂõûË™≠„ÅøËæº„Åø
            await loadArtifacts();
            setInterval(loadTokenUsage, 30000); // 30Áßí„Åî„Å®„Å´„Éà„Éº„ÇØ„É≥‰ΩøÁî®Èáè„ÇíÊõ¥Êñ∞
            setInterval(loadCreditInfo, 30000); // 30Áßí„Åî„Å®„Å´„ÇØ„É¨„Ç∏„ÉÉ„ÉàÊÉÖÂ†±„ÇíÊõ¥Êñ∞

            artifactDropzoneUpdater = initArtifactDropzone();
            handleResponsiveSidebarState();
            handleMobileFoldState({ forceCollapse: true });
            initResizeHandle();
            window.addEventListener('resize', () => {
                handleResponsiveSidebarState();
                handleMobileFoldState();
            });
        }

        async function loadModels() {
            try {
                const response = await authFetch('./api/models');
                const data = await response.json();
                availableModels = data.availableModels;
                
                const modelSelect = document.getElementById('modelSelect');
                const threadModelSelect = document.getElementById('threadModel');
                
                data.availableModels.forEach(model => {
                    const isHighCost = data.highCostModels.includes(model);
                    const optionText = `${model}${isHighCost ? ' (1M/day)' : ' (10M/day)'}`;
                    
                    const option1 = document.createElement('option');
                    option1.value = model;
                    option1.textContent = optionText;
                    modelSelect.appendChild(option1);
                    
                    const option2 = document.createElement('option');
                    option2.value = model;
                    option2.textContent = optionText;
                    if (model === data.defaultModel) option2.selected = true;
                    threadModelSelect.appendChild(option2);
                });
            } catch (error) {
                console.error('Failed to load models:', error);
            }
        }

        async function loadTokenUsage() {
            try {
                const response = await authFetch('./api/token-usage/stats');
                const data = await response.json();
                
                const highCostUsage = data.last24Hours.highCost.usage;
                const highCostLimit = data.last24Hours.highCost.limit;
                const highCostPercent = parseFloat(data.last24Hours.highCost.percentage);
                
                document.getElementById('highCostUsage').textContent = 
                    `${formatTokens(highCostUsage)} / ${formatTokens(highCostLimit)}`;
                document.getElementById('highCostPercent').textContent = 
                    `${highCostPercent.toFixed(1)}%`;
                
                const highCostBar = document.getElementById('highCostBar');
                highCostBar.style.width = `${Math.min(highCostPercent, 100)}%`;
                highCostBar.className = 'token-usage-fill';
                if (highCostPercent >= 90) highCostBar.classList.add('danger');
                else if (highCostPercent >= 70) highCostBar.classList.add('warning');
                
                const lowCostUsage = data.last24Hours.lowCost.usage;
                const lowCostLimit = data.last24Hours.lowCost.limit;
                const lowCostPercent = parseFloat(data.last24Hours.lowCost.percentage);
                
                document.getElementById('lowCostUsage').textContent = 
                    `${formatTokens(lowCostUsage)} / ${formatTokens(lowCostLimit)}`;
                document.getElementById('lowCostPercent').textContent = 
                    `${lowCostPercent.toFixed(1)}%`;
                
                const lowCostBar = document.getElementById('lowCostBar');
                lowCostBar.style.width = `${Math.min(lowCostPercent, 100)}%`;
                lowCostBar.className = 'token-usage-fill';
                if (lowCostPercent >= 90) lowCostBar.classList.add('danger');
                else if (lowCostPercent >= 70) lowCostBar.classList.add('warning');
            } catch (error) {
                console.error('Failed to load token usage:', error);
            }
        }

        function formatTokens(tokens) {
            if (tokens >= 1000000) return (tokens / 1000000).toFixed(2) + 'M';
            if (tokens >= 1000) return (tokens / 1000).toFixed(1) + 'K';
            return tokens.toString();
        }

        // „ÇØ„É¨„Ç∏„ÉÉ„ÉàÊÉÖÂ†±„ÅÆË™≠„ÅøËæº„Åø
        let CREDIT_MAX_DISPLAY = 100000; // „Éá„Éï„Ç©„É´„ÉàÂÄ§„ÄÅ„Çµ„Éº„Éê„Éº„Åã„ÇâÂèñÂæó
        
        async function loadCreditInfo() {
            try {
                const response = await authFetch('./api/auth/me');
                const data = await response.json();
                
                if (data.user && typeof data.user.remaining_credit === 'number') {
                    updateCreditDisplay(data.user.remaining_credit);
                }
                
                // „Çµ„Éº„Éê„Éº„Åã„ÇâÊúÄÂ§ßË°®Á§∫ÂÄ§„ÇíÂèñÂæóÔºàÂ≠òÂú®„Åô„ÇãÂ†¥ÂêàÔºâ
                if (data.creditMaxDisplay) {
                    CREDIT_MAX_DISPLAY = data.creditMaxDisplay;
                }
            } catch (error) {
                console.error('Failed to load credit info:', error);
            }
        }
        
        // „ÇØ„É¨„Ç∏„ÉÉ„ÉàË°®Á§∫„ÇíÊõ¥Êñ∞ÔºàÂØæÊï∞„Çπ„Ç±„Éº„É´Ôºâ
        function updateCreditDisplay(remainingCredit) {
            const creditAmount = document.getElementById('creditAmount');
            const creditText = document.getElementById('creditText');
            const creditBar = document.getElementById('creditBar');
            
            if (!creditAmount || !creditText || !creditBar) return;
            
            // „ÇØ„É¨„Ç∏„ÉÉ„Éà„Åå0‰ª•‰∏ã„ÅÆÂ†¥Âêà„ÅØÁâπÂà•„Å™Ë°®Á§∫
            if (remainingCredit <= 0) {
                creditAmount.textContent = remainingCredit.toLocaleString();
                creditAmount.style.color = '#ff3333';
                creditAmount.style.fontWeight = 'bold';
                creditAmount.style.fontSize = '14px';
                
                creditText.textContent = 'ÊÆãÈ´ò‰∏çË∂≥';
                creditText.style.color = '#ff3333';
                creditText.style.fontWeight = 'bold';
                
                creditBar.style.width = '0%';
                creditBar.className = 'token-usage-fill danger';
                return;
            }
            
            // ÈÄöÂ∏∏„ÅÆË°®Á§∫Ôºà0„Çà„ÇäÂ§ß„Åç„ÅÑÂ†¥ÂêàÔºâ
            creditAmount.style.color = '#aaa';
            creditAmount.style.fontWeight = 'normal';
            creditAmount.style.fontSize = '11px';
            creditText.style.color = '#aaa';
            creditText.style.fontWeight = 'normal';
            
            // Êï∞ÂÄ§„ÇíË°®Á§∫Ôºà„Ç´„É≥„ÉûÂå∫Âàá„ÇäÔºâ
            creditAmount.textContent = remainingCredit.toLocaleString();
            
            // ÂØæÊï∞„Çπ„Ç±„Éº„É´„Åß„Éë„Éº„Çª„É≥„ÉÜ„Éº„Ç∏„ÇíË®àÁÆó
            const logCredit = Math.log10(remainingCredit);
            const logMax = Math.log10(CREDIT_MAX_DISPLAY);
            let percentage = (logCredit / logMax) * 100;
            percentage = Math.min(Math.max(percentage, 0), 100);
            
            creditText.textContent = ``;
            creditBar.style.width = `${percentage}%`;
            
            // Ëâ≤ÂàÜ„ÅëÔºàÊÆã„ÇØ„É¨„Ç∏„ÉÉ„Éà„ÅåÂ∞ë„Å™„ÅÑÂ†¥Âêà„Å´Ë≠¶ÂëäÔºâ
            creditBar.className = 'token-usage-fill';
            if (remainingCredit < 1000) {
                creditBar.classList.add('danger');
            } else if (remainingCredit < 5000) {
                creditBar.classList.add('warning');
            }
        }

        async function changeModel() {
            if (!currentThreadId) return;
            const model = document.getElementById('modelSelect').value;
            
            try {
                await authFetch(`./api/threads/${currentThreadId}/model`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model })
                });
                console.log(`Model changed to: ${model}`);
            } catch (error) {
                console.error('Failed to change model:', error);
                alert('„É¢„Éá„É´„ÅÆÂ§âÊõ¥„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }

        async function loadThreads() {
            try {
                const response = await authFetch('./api/threads');
                const data = await response.json();
                const threadsList = document.getElementById('threadsList');
                
                if (data.threads.length === 0) {
                    threadsList.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">„Çπ„É¨„ÉÉ„Éâ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
                    return;
                }
                
                threadsList.innerHTML = data.threads
                    .sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt))
                    .map(thread => `
                        <div class="thread-item ${thread.id === currentThreadId ? 'active' : ''}" 
                             onclick="loadThread('${thread.id}')">
                            <div class="thread-item-title">${escapeHtml(thread.title)}</div>
                            <div class="thread-item-date">${formatDate(thread.updatedAt)}</div>
                        </div>
                    `).join('');
            } catch (error) {
                console.error('Failed to load threads:', error);
            }
        }

        async function loadThread(threadId) {
            try {
                const response = await authFetch(`./api/threads/${threadId}`);
                
                // „É¨„Çπ„Éù„É≥„Çπ„ÅåÊ≠£Â∏∏„Åß„Å™„ÅÑÂ†¥Âêà„ÅØ„Ç®„É©„ÉºÂá¶ÁêÜ
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Failed to load thread:', errorData.error || 'Unknown error');
                    alert(`„Çπ„É¨„ÉÉ„Éâ„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${errorData.error || 'Unknown error'}`);
                    return;
                }
                
                const thread = await response.json();
                
                // „Çπ„É¨„ÉÉ„Éâ„Éá„Éº„Çø„ÅÆÊ§úË®º
                if (!thread || !thread.messages) {
                    console.error('Invalid thread data:', thread);
                    alert('„Çπ„É¨„ÉÉ„Éâ„Éá„Éº„Çø„Åå‰∏çÊ≠£„Åß„Åô');
                    return;
                }
                
                currentThreadId = threadId;
                document.getElementById('chatTitle').textContent = thread.title;
                document.getElementById('modelSelector').style.display = 'flex';
                document.getElementById('modelSelect').value = thread.model || availableModels[0];
                document.getElementById('createArtifactBtn').disabled = false;
                document.getElementById('emptyState').style.display = 'none';
                document.getElementById('chatArea').classList.remove('hidden');
                
                applySystemPromptData({
                    systemPromptUser: thread.systemPromptUser,
                    systemPrompt: thread.systemPrompt,
                    artifactInventory: thread.artifactInventory
                });

                const messagesContainer = document.getElementById('messagesContainer');
                messagesContainer.innerHTML = '';
                
                thread.messages.forEach(msg => {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `message ${msg.role}`;
                    
                    const headerDiv = document.createElement('div');
                    headerDiv.className = 'message-header';
                    headerDiv.textContent = msg.role === 'user' ? 'You' : 'Assistant';
                    
                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'message-content';
                    contentDiv.innerHTML = formatMarkdownText(msg.content);
                    
                    const timestampDiv = document.createElement('div');
                    timestampDiv.className = 'message-timestamp';
                    timestampDiv.textContent = formatDateTime(msg.timestamp);
                    
                    messageDiv.appendChild(headerDiv);
                    messageDiv.appendChild(contentDiv);
                    messageDiv.appendChild(timestampDiv);
                    messagesContainer.appendChild(messageDiv);
                });
                
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                await loadThreads();
                await loadArtifacts();
                artifactDropzoneUpdater?.(); // „Éâ„É≠„ÉÉ„Éó„Çæ„Éº„É≥„ÅÆË°®Á§∫Áä∂ÊÖã„ÇíÊõ¥Êñ∞

                if (window.innerWidth <= 1024) {
                    closeSidebars();
                }
                updateMobileToggleIndicators();
            } catch (error) {
                console.error('Failed to load thread:', error);
                alert(`„Çπ„É¨„ÉÉ„Éâ„ÅÆË™≠„ÅøËæº„Åø‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ${error.message}`);
            }
        }
        
        function formatMarkdownText(text) {
            if (!text) return '';

            let escaped = escapeHtml(text);
            const codeBlocks = [];

            // 1. „Ç≥„Éº„Éâ„Éñ„É≠„ÉÉ„ÇØ„Çí‰∏ÄÊôÇÁöÑ„Å´„Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„Éº„Å∏
            escaped = escaped.replace(/```([\s\S]*?)```/g, (_, code) => {
                const placeholder = `%%CODEBLOCK_${codeBlocks.length}%%`;
                codeBlocks.push(code);
                return placeholder;
            });

            // 2. Ë¶ãÂá∫„ÅóÔºà#„Äú#####Ôºâ„ÇíË£ÖÈ£æ
            escaped = escaped.replace(/(^|\n)(#{1,5})([^\n]*)/g, (match, pre, hashes, content) => {
                const level = Math.min(hashes.length, 5);
                return `${pre}<span class="markdown-heading level-${level}">${hashes}${content}</span>`;
            });

            // 3. Â§™Â≠óÔºà**bold**Ôºâ„ÇíË£ÖÈ£æ
            escaped = escaped.replace(/\*\*(.+?)\*\*/g, '<span class="markdown-bold">**$1**</span>');

            // 4. „Ç≥„Éº„Éâ„Éñ„É≠„ÉÉ„ÇØ„ÇíÂÖÉ„Å´Êàª„Åó„Å¶Ë£ÖÈ£æ
            codeBlocks.forEach((code, index) => {
                const placeholder = `%%CODEBLOCK_${index}%%`;
                escaped = escaped.replace(
                    placeholder,
                    `<span class="markdown-codeblock">\`\`\`${code}\`\`\`</span>`
                );
            });

            return escaped;
        }

        function showNewThreadModal() {
            document.getElementById('newThreadModal').classList.add('active');
            document.getElementById('threadTitle').value = '';
        }

        async function createThread(event) {
            event.preventDefault();
            const title = document.getElementById('threadTitle').value;
            const model = document.getElementById('threadModel').value;
            const systemPrompt = document.getElementById('threadSystemPrompt').value;
            
            try {
                const response = await authFetch('./api/threads', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, model, systemPrompt })
                });
                
                const thread = await response.json();
                closeModal('newThreadModal');
                await loadThreads();
                await loadThread(thread.id);
            } catch (error) {
                console.error('Failed to create thread:', error);
                alert('„Çπ„É¨„ÉÉ„Éâ„ÅÆ‰ΩúÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }

        async function deleteCurrentThread() {
            if (!currentThreadId || !confirm('„Åì„ÅÆ„Çπ„É¨„ÉÉ„Éâ„ÇíÂâäÈô§„Åó„Å¶„ÇÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„Åã?')) return;
            
            try {
                await authFetch(`./api/threads/${currentThreadId}`, { method: 'DELETE' });
                closeModal('editPromptModal');
                currentThreadId = null;
                document.getElementById('chatTitle').textContent = '„Çπ„É¨„ÉÉ„Éâ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
                document.getElementById('modelSelector').style.display = 'none';
                document.getElementById('createArtifactBtn').disabled = true;
                document.getElementById('emptyState').style.display = 'flex';
                document.getElementById('chatArea').classList.add('hidden');
                await loadThreads();
                await loadArtifacts();
                artifactDropzoneUpdater?.(); // „Éâ„É≠„ÉÉ„Éó„Çæ„Éº„É≥„ÅÆË°®Á§∫Áä∂ÊÖã„ÇíÊõ¥Êñ∞
            } catch (error) {
                console.error('Failed to delete thread:', error);
                alert('„Çπ„É¨„ÉÉ„Éâ„ÅÆÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }

        function toggleSystemPromptPanel() {
            const panel = document.getElementById('systemPromptWrapper');
            panel.classList.toggle('hidden');
        }

        function applySystemPromptData(data) {
            systemPromptState.user = data.systemPromptUser || '';
            systemPromptState.effective = data.systemPrompt || '';
            systemPromptState.artifacts = data.artifactInventory || [];

            const userInput = document.getElementById('systemPromptUserInput');
            const autoPreview = document.getElementById('systemPromptAutoPreview');
            const effectivePreview = document.getElementById('systemPromptEffectivePreview');
            const saveBtn = document.getElementById('systemPromptSaveBtn');
            const refreshBtn = document.querySelector('.system-prompt-actions .btn-secondary');

            if (!userInput) return;

            userInput.value = systemPromptState.user;
            autoPreview.textContent = JSON.stringify(systemPromptState.artifacts, null, 2);
            effectivePreview.textContent = systemPromptState.effective;

            const disabled = !currentThreadId;
            userInput.disabled = disabled;
            saveBtn.disabled = disabled;
            refreshBtn.disabled = disabled;
        }

        async function fetchSystemPrompt() {
            if (!currentThreadId) return;
            try {
                const response = await authFetch(`./api/threads/${currentThreadId}/system-prompt`);
                const data = await response.json();
                applySystemPromptData(data);
            } catch (error) {
                console.error('Failed to fetch system prompt:', error);
            }
        }

        async function saveSystemPrompt() {
            if (!currentThreadId) return;
            try {
                const basePrompt = document.getElementById('systemPromptUserInput').value;
                const response = await authFetch(`./api/threads/${currentThreadId}/system-prompt`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ systemPrompt: basePrompt })
                });
                const data = await response.json();
                applySystemPromptData(data);
                document.getElementById('systemPromptStatus').textContent = '„Éó„É≠„É≥„Éó„Éà„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü (Ëá™ÂãïÂêåÊúü‰∏≠)';
            } catch (error) {
                console.error('Failed to save system prompt:', error);
                alert('„Ç∑„Çπ„ÉÜ„É†„Éó„É≠„É≥„Éó„Éà„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }

        function getFileExtension(filename = '') {
            const lastDot = filename.lastIndexOf('.');
            if (lastDot === -1) return '';
            return filename.slice(lastDot).toLowerCase();
        }

        function isAllowedTextExtension(filename = '') {
            const ext = getFileExtension(filename);
            if (!ext) return false;
            return ALLOWED_TEXT_EXTENSIONS.has(ext);
        }

        function splitFilesByExtension(files = []) {
            const allowed = [];
            const rejected = [];
            files.forEach((file) => {
                if (isAllowedTextExtension(file.name)) {
                    allowed.push(file);
                } else {
                    rejected.push(file);
                }
            });
            return { allowed, rejected };
        }

        function initArtifactDropzone() {
            const dropzone = document.getElementById('artifactDropzone');
            const fileInput = document.getElementById('artifactFileInput');

            if (!dropzone || !fileInput) return;

            const updateDropzoneState = () => {
                dropzone.classList.toggle('disabled', !currentThreadId || isUploadingArtifacts);
                dropzone.querySelector('#artifactDropzoneLabel').textContent =
                    !currentThreadId ? '„Çπ„É¨„ÉÉ„Éâ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ' :
                    isUploadingArtifacts ? '„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ‰∏≠...' :
                    DROPZONE_TEXT_DEFAULT;
            };

            const highlight = (evt) => {
                evt.preventDefault();
                if (!currentThreadId || isUploadingArtifacts) return;
                dropzone.classList.add('dragover');
            };

            const unhighlight = (evt) => {
                evt.preventDefault();
                dropzone.classList.remove('dragover');
            };

            const handleDrop = (evt) => {
                evt.preventDefault();
                if (!currentThreadId || isUploadingArtifacts) return;
                const files = evt.dataTransfer?.files;
                if (files?.length) {
                    uploadArtifacts(files);
                }
            };

            dropzone.addEventListener('click', () => {
                if (!currentThreadId || isUploadingArtifacts) return;
                fileInput.click();
            });

            dropzone.addEventListener('dragenter', highlight);
            dropzone.addEventListener('dragover', highlight);
            dropzone.addEventListener('dragleave', unhighlight);
            dropzone.addEventListener('drop', (evt) => {
                unhighlight(evt);
                handleDrop(evt);
            });

            fileInput.addEventListener('change', (evt) => {
                const files = evt.target.files;
                if (files?.length) {
                    uploadArtifacts(files);
                    fileInput.value = '';
                }
            });

            updateDropzoneState();

            return updateDropzoneState;
        }

        async function uploadArtifacts(fileList) {
            if (!currentThreadId || isUploadingArtifacts) return;

            const filesArray = Array.isArray(fileList) ? fileList : Array.from(fileList || []);
            if (!filesArray.length) return;

            const { allowed, rejected } = splitFilesByExtension(filesArray);

            if (rejected.length) {
                const rejectedNames = rejected.map(file => `„Éª${file.name}`).join('\n');
                alert(`„ÉÜ„Ç≠„Çπ„Éà‰ª•Â§ñ„ÅÆÊã°ÂºµÂ≠ê„ÄÅ„Åæ„Åü„ÅØÊã°ÂºµÂ≠ê„ÅåÊú™Ë®≠ÂÆö„ÅÆ„Éï„Ç°„Ç§„É´„ÅØ„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åß„Åç„Åæ„Åõ„Çì„ÄÇ\n„Çπ„Ç≠„ÉÉ„Éó„Åï„Çå„Åü„Éï„Ç°„Ç§„É´:\n${rejectedNames}\n\nÂØæÂøú„Åó„Å¶„ÅÑ„ÇãÊã°ÂºµÂ≠ê:\n${ALLOWED_TEXT_EXTENSIONS_MESSAGE}`);
            }

            if (!allowed.length) {
                return;
            }

            const formData = new FormData();
            formData.append('threadId', currentThreadId);

            const metadataMap = {};
            allowed.forEach((file) => {
                formData.append('files', file);
                metadataMap[file.name] = {
                    description: `Uploaded via UI at ${new Date().toISOString()}`
                };
            });
            formData.append('metadata', JSON.stringify(metadataMap));

            isUploadingArtifacts = true;
            artifactDropzoneUpdater?.();

            const dropzone = document.getElementById('artifactDropzone');
            const artifactsList = document.getElementById('artifactsList');
            const statusLabel = dropzone?.querySelector('#artifactDropzoneLabel');
            const originalLabel = statusLabel?.textContent;

            try {
                statusLabel.textContent = `„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ‰∏≠ (${allowed.length} „Éï„Ç°„Ç§„É´)...`;
                const response = await authFetch('./api/artifacts/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                const { results = [] } = result;
                if (!response.ok && response.status !== 207) throw new Error('„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');

                const errors = results.filter(item => item.error);
                if (errors.length) {
                    console.warn('‰∏ÄÈÉ®„ÅÆ„Éï„Ç°„Ç§„É´„ÅåÂ§±Êïó:', errors);
                    alert(`‰∏ÄÈÉ®„ÅÆ„Éï„Ç°„Ç§„É´„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ\n${errors.map(err => `${err.originalName}: ${err.error}`).join('\n')}`);
                } else {
                    alert('„Éï„Ç°„Ç§„É´„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åó„Åæ„Åó„Åü');
                }

                await Promise.all([
                    loadArtifacts(),
                    fetchSystemPrompt()
                ]);
            } catch (error) {
                console.error('uploadArtifacts error:', error);
                alert(error.message || '„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                if (artifactsList) {
                    artifactsList.innerHTML = '<div style="padding: 20px; text-align: center; color: #ff6666;">„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü</div>';
                }
            } finally {
                isUploadingArtifacts = false;
                if (statusLabel) statusLabel.textContent = originalLabel;
                artifactDropzoneUpdater?.();
            }
        }

        function showUsageLimitPopup() {
            alert('„Åù„Çç„Åù„Çç24h„ÅÆÁÑ°ÊñôÂà©Áî®Êû†„ÇíË∂Ö„Åà„Çã„ÅÆ„Åß„ÄÅ„Åó„Å∞„Çâ„ÅèÂæÖ„Å£„Å¶„Å≠ÔºÅ');
        }

        async function sendMessage(event) {
            event.preventDefault();
            if (!currentThreadId) return;

            const input = document.getElementById('messageInput');
            const content = input.value.trim();
            if (!content) return;

            const sendBtn = document.getElementById('sendBtn');
            const originalText = sendBtn.textContent;
            sendBtn.disabled = true;
            sendBtn.textContent = 'ÈÄÅ‰ø°‰∏≠...';
            input.disabled = true;

            try {
                const response = await authFetch(`./api/threads/${currentThreadId}/messages`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content })
                });

                if (response.status === 429) {
                    try {
                        await response.json();
                    } catch (_) {}
                    showUsageLimitPopup();
                    return;
                }

                if (!response.ok) {
                    let errorData = null;
                    try {
                        errorData = await response.json();
                    } catch (_) {}
                    throw new Error(errorData?.error || '„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆÈÄÅ‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }

                await response.json();
                input.value = '';
                await loadThread(currentThreadId);
                await loadThreads();
                await loadArtifacts();
                artifactDropzoneUpdater?.(); // „Éâ„É≠„ÉÉ„Éó„Çæ„Éº„É≥„ÅÆË°®Á§∫Áä∂ÊÖã„ÇíÊõ¥Êñ∞
            } catch (error) {
                console.error('Failed to send message:', error);
                alert(`„Ç®„É©„Éº: ${error.message}`);
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = originalText;
                input.disabled = false;
                input.focus();
                await loadTokenUsage();
                await loadCreditInfo(); // „ÇØ„É¨„Ç∏„ÉÉ„ÉàÊÉÖÂ†±„ÇíÊõ¥Êñ∞
            }
        }

        async function loadArtifacts() {
            try {
                const url = currentThreadId ? `./api/artifacts?threadId=${currentThreadId}` : './api/artifacts';
                const response = await fetch(url);
                const data = await response.json();
                const artifactsList = document.getElementById('artifactsList');
                
                if (data.artifacts.length === 0) {
                    const message = currentThreadId ? '„Åì„ÅÆ„Çπ„É¨„ÉÉ„Éâ„Å´„ÅØ„Ç¢„Éº„ÉÜ„Ç£„Éï„Ç°„ÇØ„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì' : '„Ç¢„Éº„ÉÜ„Ç£„Éï„Ç°„ÇØ„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì';
                    artifactsList.innerHTML = `<div style="padding: 20px; text-align: center; color: #666;">${message}</div>`;
                    return;
                }

                artifactsList.innerHTML = data.artifacts
                    .sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt))
                    .map(artifact => `
                        <div class="artifact-item">
                            <div class="artifact-filename">${escapeHtml(artifact.filename)}</div>
                            <div class="artifact-meta">v${artifact.currentVersion} (${artifact.versionCount} versions)</div>
                            <div class="artifact-meta">${formatDate(artifact.updatedAt)}</div>
                            <div class="artifact-actions">
                                <button class="artifact-btn" onclick="viewArtifact('${artifact.id}')">Ë°®Á§∫</button>
                                <button class="artifact-btn" onclick="downloadArtifact('${artifact.id}')">DL</button>
                                <button class="artifact-btn" style="background: #cc0000;" onclick="deleteArtifact('${artifact.id}')">ÂâäÈô§</button>
                            </div>
                        </div>
                    `).join('');
            } catch (error) {
                console.error('Failed to load artifacts:', error);
            }
        }

        async function viewArtifact(artifactId) {
            try {
                const response = await authFetch(`./api/artifacts/${artifactId}`);
                const artifact = await response.json();
                
                currentArtifact = artifact;
                document.getElementById('artifactModalTitle').textContent = `${artifact.filename} (v${artifact.version})`;
                document.getElementById('artifactContent').textContent = artifact.content;
                document.getElementById('artifactModal').classList.add('active');
            } catch (error) {
                console.error('Failed to view artifact:', error);
                alert('„Ç¢„Éº„ÉÜ„Ç£„Éï„Ç°„ÇØ„Éà„ÅÆË°®Á§∫„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }

        async function downloadArtifact(artifactId) {
            try {
                const response = await authFetch(`./api/artifacts/${artifactId}`);
                const artifact = await response.json();
                
                const blob = new Blob([artifact.content], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = artifact.filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Failed to download artifact:', error);
                alert('„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }

        function downloadCurrentArtifact() {
            if (!currentArtifact) return;
            
            const blob = new Blob([currentArtifact.content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = currentArtifact.filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function showCreateArtifactModal() {
            if (!currentThreadId) {
                alert('„Çπ„É¨„ÉÉ„Éâ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            document.getElementById('createArtifactModal').classList.add('active');
            document.getElementById('artifactFilename').value = '';
            document.getElementById('artifactContentInput').value = '';
            document.getElementById('artifactDescription').value = '';
        }

        async function createArtifact(event) {
            event.preventDefault();
            if (!currentThreadId) return;

            const filenameInput = document.getElementById('artifactFilename');
            const rawFilename = filenameInput.value.trim();
            const content = document.getElementById('artifactContentInput').value;
            const description = document.getElementById('artifactDescription').value;

            if (!rawFilename) {
                alert('„Éï„Ç°„Ç§„É´Âêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                filenameInput.focus();
                return;
            }

            if (!isAllowedTextExtension(rawFilename)) {
                const ext = getFileExtension(rawFilename);
                if (!ext) {
                    alert(`„ÉÜ„Ç≠„Çπ„Éà„Éï„Ç°„Ç§„É´„ÅÆÊã°ÂºµÂ≠ê„Çí‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\nÂØæÂøú„Åó„Å¶„ÅÑ„ÇãÊã°ÂºµÂ≠ê: ${ALLOWED_TEXT_EXTENSIONS_MESSAGE}`);
                } else {
                    alert(`Êã°ÂºµÂ≠ê„Äå${ext}„Äç„ÅØÁèæÂú®„Çµ„Éù„Éº„Éà„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ\nÂØæÂøú„Åó„Å¶„ÅÑ„ÇãÊã°ÂºµÂ≠ê: ${ALLOWED_TEXT_EXTENSIONS_MESSAGE}`);
                }
                filenameInput.focus();
                return;
            }

            try {
                const response = await authFetch('./api/artifacts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        filename: rawFilename,
                        content,
                        threadId: currentThreadId,
                        metadata: { description: description || '' }
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || '„Ç¢„Éº„ÉÜ„Ç£„Éï„Ç°„ÇØ„Éà„ÅÆ‰ΩúÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }

                closeModal('createArtifactModal');
                await loadArtifacts();
                artifactDropzoneUpdater?.(); // „Éâ„É≠„ÉÉ„Éó„Çæ„Éº„É≥„ÅÆË°®Á§∫Áä∂ÊÖã„ÇíÊõ¥Êñ∞
                await fetchSystemPrompt(); 
                alert('„Ç¢„Éº„ÉÜ„Ç£„Éï„Ç°„ÇØ„Éà„Çí‰ΩúÊàê„Åó„Åæ„Åó„Åü');
            } catch (error) {
                console.error('Failed to create artifact:', error);
                alert(`„Ç®„É©„Éº: ${error.message}`);
            }
        }

        function editCurrentArtifact() {
            if (!currentArtifact) return;
            
            document.getElementById('editArtifactFilename').value = currentArtifact.filename;
            document.getElementById('editArtifactContent').value = currentArtifact.content;
            document.getElementById('editArtifactDescription').value = currentArtifact.metadata?.description || '';
            
            closeModal('artifactModal');
            document.getElementById('editArtifactModal').classList.add('active');
        }

        async function saveArtifactEdit(event) {
            event.preventDefault();
            if (!currentArtifact) return;

            const content = document.getElementById('editArtifactContent').value;
            const description = document.getElementById('editArtifactDescription').value;

            try {
                const response = await authFetch(`./api/artifacts/${currentArtifact.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        content,
                        metadata: { description: description || '' }
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || '„Ç¢„Éº„ÉÜ„Ç£„Éï„Ç°„ÇØ„Éà„ÅÆÁ∑®ÈõÜ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }

                closeModal('editArtifactModal');
                await loadArtifacts();
                artifactDropzoneUpdater?.(); // „Éâ„É≠„ÉÉ„Éó„Çæ„Éº„É≥„ÅÆË°®Á§∫Áä∂ÊÖã„ÇíÊõ¥Êñ∞
                await fetchSystemPrompt();
                alert('„Ç¢„Éº„ÉÜ„Ç£„Éï„Ç°„ÇØ„Éà„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü');
            } catch (error) {
                console.error('Failed to edit artifact:', error);
                alert(`„Ç®„É©„Éº: ${error.message}`);
            }
        }

        async function deleteArtifact(artifactId) {
            if (!confirm('„Åì„ÅÆ„Ç¢„Éº„ÉÜ„Ç£„Éï„Ç°„ÇØ„Éà„ÇíÂâäÈô§„Åó„Å¶„ÇÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü')) return;
            
            try {
                const response = await authFetch(`./api/artifacts/${artifactId}`, { method: 'DELETE' });
                if (!response.ok) throw new Error('ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                
                await loadArtifacts();
                artifactDropzoneUpdater?.(); // „Éâ„É≠„ÉÉ„Éó„Çæ„Éº„É≥„ÅÆË°®Á§∫Áä∂ÊÖã„ÇíÊõ¥Êñ∞
                await fetchSystemPrompt();
                alert('„Ç¢„Éº„ÉÜ„Ç£„Éï„Ç°„ÇØ„Éà„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü');
            } catch (error) {
                console.error('Failed to delete artifact:', error);
                alert('ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function handleInputKeydown(event) {
            if (event.key === 'Enter' && event.shiftKey) {
                event.preventDefault();
                sendMessage(event);
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (minutes < 1) return '„Åü„Å£„Åü‰ªä';
            if (minutes < 60) return `${minutes}ÂàÜÂâç`;
            if (hours < 24) return `${hours}ÊôÇÈñìÂâç`;
            if (days < 7) return `${days}Êó•Ââç`;
            return date.toLocaleDateString('ja-JP');
        }

        function formatDateTime(dateString) {
            return new Date(dateString).toLocaleString('ja-JP');
        }

        function toggleLeftSidebar() {
            const isOpen = document.body.classList.toggle('show-left-sidebar');
            if (isOpen) {
                document.body.classList.remove('show-right-sidebar');
            }
            updateSidebarOverlayState();
        }

        function toggleRightSidebar() {
            const isOpen = document.body.classList.toggle('show-right-sidebar');
            if (isOpen) {
                document.body.classList.remove('show-left-sidebar');
            }
            updateSidebarOverlayState();
        }

        function closeSidebars() {
            document.body.classList.remove('show-left-sidebar', 'show-right-sidebar');
            updateSidebarOverlayState();
        }

        function updateSidebarOverlayState() {
            const hasOpen = document.body.classList.contains('show-left-sidebar') || document.body.classList.contains('show-right-sidebar');
            document.body.classList.toggle('sidebar-open', hasOpen);
        }

        function handleResponsiveSidebarState() {
            if (window.innerWidth > 1024) {
                document.body.classList.remove('show-left-sidebar', 'show-right-sidebar', 'sidebar-open');
            }
        }

        function toggleMobileHeader() {
            if (window.innerWidth > MOBILE_BREAKPOINT) return;
            const chatHeader = document.querySelector('.chat-header');
            if (!chatHeader) return;
            chatHeader.classList.toggle('collapsed');
            updateMobileToggleIndicators();
        }

        function toggleMobileInput() {
            if (window.innerWidth > MOBILE_BREAKPOINT) return;
            const inputArea = document.querySelector('.input-area');
            if (!inputArea) return;
            const isCollapsed = inputArea.classList.toggle('collapsed');
            updateMobileToggleIndicators();
            if (!isCollapsed) {
                document.getElementById('messageInput')?.focus();
            }
        }

        function handleMobileFoldState({ forceCollapse = false } = {}) {
            const isMobile = window.innerWidth <= MOBILE_BREAKPOINT;
            const chatHeader = document.querySelector('.chat-header');
            const inputArea = document.querySelector('.input-area');

            if (isMobile) {
                if (forceCollapse || isMobileViewport !== true) {
                    chatHeader?.classList.add('collapsed');
                    inputArea?.classList.add('collapsed');
                }
            } else {
                chatHeader?.classList.remove('collapsed');
                inputArea?.classList.remove('collapsed');
            }

            isMobileViewport = isMobile;
            updateMobileToggleIndicators();
        }

        function updateMobileToggleIndicators() {
            const isMobile = window.innerWidth <= MOBILE_BREAKPOINT;
            const chatHeader = document.querySelector('.chat-header');
            const headerToggle = document.getElementById('mobileHeaderToggle');
            if (chatHeader && headerToggle) {
                const collapsed = chatHeader.classList.contains('collapsed');
                headerToggle.setAttribute('aria-expanded', (!collapsed).toString());
                const headerLabel = headerToggle.querySelector('.toggle-label');
                if (headerLabel) {
                    headerLabel.textContent = collapsed ? '„Éò„ÉÉ„ÉÄ„Éº„ÇíÈñã„Åè' : '„Éò„ÉÉ„ÉÄ„Éº„ÇíÈñâ„Åò„Çã';
                }
                if (!isMobile) {
                    headerToggle.setAttribute('aria-expanded', 'true');
                }
            }

            const inputArea = document.querySelector('.input-area');
            const inputToggle = document.getElementById('mobileInputToggle');
            if (inputArea && inputToggle) {
                const collapsed = inputArea.classList.contains('collapsed');
                inputToggle.setAttribute('aria-expanded', (!collapsed).toString());
                const inputLabel = inputToggle.querySelector('.toggle-label');
                if (inputLabel) {
                    inputLabel.textContent = collapsed ? 'ÂÖ•ÂäõÊ¨Ñ„ÇíÈñã„Åè' : 'ÂÖ•ÂäõÊ¨Ñ„ÇíÈñâ„Åò„Çã';
                }
                if (!isMobile) {
                    inputToggle.setAttribute('aria-expanded', 'true');
                }
            }
        }

        init();
    </script>
</body>
</html>