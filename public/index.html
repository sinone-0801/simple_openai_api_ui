<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>OpenAI API UI</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #1a1a1a;
            color: #e0e0e0;
            height: 100vh; /* ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ */
            height: 100dvh; /* å‹•çš„ãªãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆé«˜ã•ï¼ˆãƒ¢ãƒã‚¤ãƒ«ã®UIã‚’è€ƒæ…®ï¼‰ */
            overflow: hidden;
            display: flex;
            margin: 0;
            padding: 0;
        }

        .container {
            display: flex;
            flex: 1;
            height: 100%;
            width: 100%;
            overflow: hidden;
            position: relative;
            /* safe-areaã‚’containerå†…ã§å‡¦ç†ï¼ˆCSSå¤‰æ•°ã§ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰å¯èƒ½ï¼‰ */
            padding-top: var(--sat, env(safe-area-inset-top, 0px));
            padding-bottom: var(--sab, env(safe-area-inset-bottom, 0px));
            padding-left: var(--sal, env(safe-area-inset-left, 0px));
            padding-right: var(--sar, env(safe-area-inset-right, 0px));
        }

        .sidebar {
            width: 280px;
            background: #2a2a2a;
            border-right: 1px solid #3a3a3a;
            display: flex;
            flex-direction: column;
            transition: width 0.3s ease, transform 0.3s ease;
            z-index: 15;
            position: relative;
        }

        .sidebar.collapsed {
            width: 40px;
        }

        .sidebar.collapsed .sidebar-header,
        .sidebar.collapsed .threads-list {
            opacity: 0;
            pointer-events: none;
        }

        .sidebar-collapse-btn {
            position: absolute;
            top: 50%;
            right: -15px;
            transform: translateY(-50%);
            width: 30px;
            height: 60px;
            background: #2a2a2a;
            border: 1px solid #3a3a3a;
            border-radius: 0 8px 8px 0;
            color: #e0e0e0;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            z-index: 10;
            transition: background 0.2s;
        }

        .sidebar-collapse-btn:hover {
            background: #333;
        }

        .sidebar.collapsed .sidebar-collapse-btn {
            right: -15px;
            border-radius: 0 8px 8px 0;
        }

        .sidebar-close-btn {
            display: none;
            position: absolute;
            top: 12px;
            right: 12px;
            background: transparent;
            border: none;
            color: #e0e0e0;
            font-size: 20px;
            cursor: pointer;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #3a3a3a;
            flex-shrink: 0;
            position: relative;
        }

        .sidebar-header h1 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #fff;
        }

        .new-thread-btn {
            width: 100%;
            padding: 10px;
            background: #0066cc;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s;
        }

        .new-thread-btn:hover {
            background: #0052a3;
        }

        .stats-wrapper {
            margin-top: 15px;
            padding: 15px;
            background: #333;
            border-radius: 6px;
            position: relative;
        }

        .stats-wrapper .token-usage-panel {
            padding: 0;
            background: transparent;
            border-radius: 0;
            margin-top: 0;
            padding-top: 15px;
        }

        .stats-wrapper .token-usage-panel:first-child {
            padding-top: 0;
        }

        .token-usage-panel {
            padding: 15px;
            background: #333;
            border-radius: 6px;
            margin-top: 15px;
            position: relative;
        }

        .token-usage-title {
            font-size: 13px;
            font-weight: 600;
            color: #aaa;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .panel-toggle-btn {
            background: transparent;
            border: none;
            color: #999;
            font-size: 14px;
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 3px;
            transition: background 0.2s;
        }

        .panel-toggle-btn:hover {
            background: #444;
            color: #fff;
        }

        .collapsible-panel {
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease;
            max-height: 500px;
            opacity: 1;
        }

        .collapsible-panel.collapsed {
            max-height: 0;
            opacity: 0;
            margin: 0;
            padding: 0;
        }

        .token-usage-item {
            margin-bottom: 12px;
        }

        .token-usage-label {
            font-size: 12px;
            color: #999;
            margin-bottom: 4px;
        }

        .token-usage-bar {
            width: 100%;
            height: 8px;
            background: #222;
            border-radius: 4px;
            overflow: hidden;
        }

        .token-usage-fill {
            height: 100%;
            background: linear-gradient(90deg, #0066cc, #00aaff);
            transition: width 0.3s ease;
        }

        .token-usage-fill.warning {
            background: linear-gradient(90deg, #ff8800, #ffaa00);
        }

        .token-usage-fill.danger {
            background: linear-gradient(90deg, #ff3333, #ff5555);
        }

        .token-usage-text {
            font-size: 11px;
            color: #aaa;
            margin-top: 4px;
            display: flex;
            justify-content: space-between;
        }

        .threads-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .thread-item {
            padding: 12px;
            margin-bottom: 4px;
            background: #333;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .thread-item:hover {
            background: #3a3a3a;
        }

        .thread-item.active {
            background: #0066cc;
        }

        .thread-item-title {
            font-weight: 500;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .thread-item-date {
            font-size: 12px;
            color: #999;
        }

        .main-content {
            display: flex;
            flex-direction: column;
            flex: 1;
            background: #1a1a1a;
            overflow: hidden;
            transition: filter 0.3s ease;
        }

        .mobile-header-toggle,
        .mobile-input-toggle {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 14px;
            border-radius: 6px;
            border: 1px solid #444;
            background: #333;
            color: #e0e0e0;
            font-size: 14px;
            cursor: pointer;
        }

        .mobile-header-toggle:active,
        .mobile-input-toggle:active {
            background: #3f3f3f;
        }

        .toggle-icon {
            font-size: 16px;
        }

        .mobile-toolbar {
            display: none;
            gap: 10px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .mobile-toggle-btn {
            flex: 1 1 auto;
            min-width: 120px;
            padding: 10px 12px;
            border-radius: 6px;
            border: 1px solid #444;
            background: #333;
            color: #e0e0e0;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .mobile-toggle-btn:active {
            background: #3f3f3f;
        }

        .chat-header {
            /* safe-areaã‚’è€ƒæ…®ã—ãŸæœ€å¤§é«˜ã•ï¼ˆCSSå¤‰æ•°ã§ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰å¯èƒ½ï¼‰ */
            max-height: calc(85vh - var(--sat, env(safe-area-inset-top, 0px)) - var(--sab, env(safe-area-inset-bottom, 0px)));
            max-height: calc(85dvh - var(--sat, env(safe-area-inset-top, 0px)) - var(--sab, env(safe-area-inset-bottom, 0px)));
            overflow-y: auto;
            padding-right: 12px;
            padding: 20px;
            border-bottom: 1px solid #3a3a3a;
            background: #2a2a2a;
            flex-shrink: 0;
        }

        .chat-header h2 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .chat-header-content {
            display: flex;
            flex-direction: column;
            gap: 0;
        }
        
        .chat-header.collapsed .chat-header-content,
        .input-area.collapsed .input-area-content {
            display: none;
        }

        .chat-header::-webkit-scrollbar {
            width: 6px;
        }
        .chat-header::-webkit-scrollbar-track {
            background: #2a2a2a;
        }
        .chat-header::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 3px;
        }

        .model-selector {
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .model-selector label {
            font-size: 13px;
            color: #aaa;
        }

        .model-selector select {
            padding: 6px 10px;
            background: #333;
            color: #e0e0e0;
            border: 1px solid #444;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
        }

        .model-selector select:hover {
            background: #3a3a3a;
        }

        .system-prompt-header {
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .system-prompt-header label {
            font-size: 13px;
            color: #aaa;
        }

        .system-prompt-header select {
            padding: 6px 10px;
            background: #333;
            color: #e0e0e0;
            border: 1px solid #444;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
        }

        .system-prompt-header select:hover {
            background: #3a3a3a;
        }

        .system-prompt-wrapper {
            margin-top: 16px;
            background: #262626;
            border: 1px solid #3a3a3a;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            padding: 12px;
        }

        .system-prompt-wrapper.hidden {
            display: none;
        }

        .system-prompt-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .system-prompt-title {
            font-size: 14px;
            font-weight: 600;
            color: #ddd;
        }

        .system-prompt-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .system-prompt-status {
            font-size: 12px;
            color: #66c0ff;
        }

        .system-prompt-toggle {
            padding: 6px 12px;
            background: #444;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .system-prompt-toggle:hover {
            background: #555;
        }

        .system-prompt-panel {
            margin-top: 12px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .system-prompt-panel.hidden {
            display: none;
        }

        .system-prompt-textarea {
            min-height: 120px;
            font-family: monospace;
            background: #1e1e1e;
        }

        .system-prompt-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .system-prompt-section {
            background: #1f1f1f;
            border: 1px solid #333;
            border-radius: 6px;
            padding: 10px;
        }

        .system-prompt-section-title {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 6px;
            color: #aaa;
        }

        #systemPromptAutoPreview,
        #systemPromptEffectivePreview {
            max-height: 200px;
            overflow: auto;
        }

        .chat-area {
            display: flex;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
        }

        .chat-area.hidden {
            display: none;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .message {
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
        }

        .message-header {
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .message.user .message-header {
            color: #4a9eff;
        }

        .message.assistant .message-header {
            color: #00d166;
        }

        .message-content {
            padding: 12px 16px;
            border-radius: 8px;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .message.user .message-content {
            background: #2a3f5f;
            max-width: 80%;
        }

        .message.assistant .message-content {
            background: #1a3a2a;
            max-width: 90%;
        }

        .message-timestamp {
            font-size: 11px;
            color: #666;
            margin-top: 4px;
        }

        .input-area {
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            border-top: 1px solid #3a3a3a;
            background: #2a2a2a;
            flex-shrink: 0;
        }

        .input-area-content {
            width: 100%;
        }

        .input-form {
            display: flex;
            gap: 10px;
        }

        .message-input {
            flex: 1;
            padding: 12px;
            background: #333;
            border: 1px solid #444;
            border-radius: 6px;
            color: #e0e0e0;
            font-size: 14px;
            resize: none;
            min-height: 120px;
            /* safe-areaã‚’è€ƒæ…®ã—ãŸæœ€å¤§é«˜ã•ï¼ˆCSSå¤‰æ•°ã§ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰å¯èƒ½ï¼‰ */
            max-height: calc(60vh - var(--sat, env(safe-area-inset-top, 0px)) - var(--sab, env(safe-area-inset-bottom, 0px)));
            max-height: calc(60dvh - var(--sat, env(safe-area-inset-top, 0px)) - var(--sab, env(safe-area-inset-bottom, 0px)));
            font-family: inherit;
        }

        .input-wrapper {
            position: relative;
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        .resize-handle {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 8px;
            cursor: ns-resize;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .resize-handle::before {
            content: '';
            width: 40px;
            height: 4px;
            background: #555;
            border-radius: 2px;
            transition: background 0.2s;
        }

        .resize-handle:hover::before {
            background: #0066cc;
        }

        .resize-handle:active::before {
            background: #0052a3;
        }

        .message-input:focus {
            outline: none;
            border-color: #0066cc;
        }

        .send-btn {
            padding: 12px 24px;
            background: #0066cc;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s;
            align-self: flex-end;
        }

        .send-btn:hover:not(:disabled) {
            background: #0052a3;
        }

        .send-btn:disabled {
            background: #555;
            cursor: not-allowed;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
            padding: 40px;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-state-text {
            font-size: 18px;
            color: #666;
            text-align: center;
        }

        /* ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆãƒ‘ãƒãƒ« */
        .artifacts-panel {
            width: 320px;
            background: #2a2a2a;
            border-left: 1px solid #3a3a3a;
            display: flex;
            flex-direction: column;
            transition: width 0.3s ease, transform 0.3s ease;
            z-index: 15;
            position: relative;
        }

        .artifacts-panel.collapsed {
            width: 40px;
        }

        .artifacts-panel.collapsed .artifacts-header,
        .artifacts-panel.collapsed .artifacts-list {
            opacity: 0;
            pointer-events: none;
        }

        .artifacts-collapse-btn {
            position: absolute;
            top: 50%;
            left: -15px;
            transform: translateY(-50%);
            width: 30px;
            height: 60px;
            background: #2a2a2a;
            border: 1px solid #3a3a3a;
            border-radius: 8px 0 0 8px;
            color: #e0e0e0;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            z-index: 10;
            transition: background 0.2s;
        }

        .artifacts-collapse-btn:hover {
            background: #333;
        }

        .artifacts-panel.collapsed .artifacts-collapse-btn {
            left: -15px;
            border-radius: 8px 0 0 8px;
        }

        .artifacts-close-btn {
            display: none;
            position: absolute;
            top: 12px;
            right: 12px;
            background: transparent;
            border: none;
            color: #e0e0e0;
            font-size: 20px;
            cursor: pointer;
        }

        .artifact-dropzone {
            margin-top: 12px;
            padding: 16px;
            border: 2px dashed #555;
            border-radius: 6px;
            text-align: center;
            color: #aaa;
            cursor: pointer;
            transition: border-color 0.2s, background 0.2s;
            font-size: 13px;
        }

        .artifact-dropzone.dragover {
            border-color: #00aaff;
            background: rgba(0, 170, 255, 0.1);
            color: #fff;
        }

        .artifact-dropzone.disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .artifacts-header {
            padding: 20px;
            border-bottom: 1px solid #3a3a3a;
            flex-shrink: 0;
            position: relative;
        }

        .artifacts-header h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .create-artifact-btn {
            width: 100%;
            padding: 8px;
            background: #0066cc;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: background 0.2s;
        }

        .create-artifact-btn:hover:not(:disabled) {
            background: #0052a3;
        }

        .create-artifact-btn:disabled {
            background: #444;
            cursor: not-allowed;
        }

        .artifacts-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .artifact-item {
            padding: 12px;
            margin-bottom: 8px;
            background: #333;
            border-radius: 6px;
        }

        .artifact-filename {
            font-weight: 500;
            margin-bottom: 4px;
            word-break: break-all;
        }

        .artifact-meta {
            font-size: 12px;
            color: #999;
        }

        .artifact-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .artifact-btn {
            padding: 4px 8px;
            background: #444;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
        }

        .artifact-btn:hover {
            background: #555;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #2a2a2a;
            padding: 24px;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-size: 14px;
            font-weight: 500;
        }

        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            padding: 10px;
            background: #333;
            border: 1px solid #444;
            border-radius: 4px;
            color: #e0e0e0;
            font-size: 14px;
            font-family: inherit;
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-input:focus,
        .form-textarea:focus,
        .form-select:focus {
            outline: none;
            border-color: #0066cc;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }

        .btn-primary {
            background: #0066cc;
            color: white;
        }

        .btn-primary:hover {
            background: #0052a3;
        }

        .btn-secondary {
            background: #444;
            color: white;
        }

        .btn-secondary:hover {
            background: #555;
        }

        .delete-thread-btn {
            margin-top: 8px;
            padding: 6px 12px;
            background: #cc0000;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .delete-thread-btn:hover {
            background: #aa0000;
        }

        .thread-delete-container {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #3a3a3a;
        }

        pre {
            background: #1a1a1a;
            padding: 12px;
            border-radius: 4px;
            overflow-x: auto;
            margin: 8px 0;
        }

        code {
            font-family: 'Courier New', Courier, monospace;
            font-size: 13px;
        }

        .markdown-heading {
            display: block;
            font-weight: 600;
            margin: 0.3em 0 0.2em;
        }

        /* markdown æ›¸å¼è¨­å®š */
        .markdown-heading.level-1 { font-size: 1.6em; }
        .markdown-heading.level-2 { font-size: 1.45em; }
        .markdown-heading.level-3 { font-size: 1.3em; }
        .markdown-heading.level-4 { font-size: 1.2em; }
        .markdown-heading.level-5 { font-size: 1.1em; }

        .markdown-bold {
            font-weight: 700;
        }

        .markdown-codeblock {
            display: block;
            color: #ffcc66;
            font-family: 'Courier New', Courier, monospace;
            white-space: pre-wrap;
            margin: 8px 0;
        }

        .mobile-overlay {
            display: none;
        }

        /* PCç‰ˆï¼šã‚µã‚¤ãƒ‰ãƒãƒ¼æŠ˜ã‚ŠãŸãŸã¿ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º */
        @media (min-width: 1025px) {
            .sidebar-collapse-btn,
            .artifacts-collapse-btn {
                display: flex;
            }
        }

        @media (max-width: 1024px) {
            body {
                flex-direction: column;
                overflow: hidden;
                height: 100vh;
                /* ãƒ¢ãƒã‚¤ãƒ«ã§ã¯bodyã®paddingã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆAndroidãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼å¯¾å¿œï¼‰ */
                padding: 0 !important;
            }

            .container {
                flex-direction: column;
            }

            .sidebar,
            .artifacts-panel {
                position: fixed;
                top: 0;
                bottom: 0;
                width: min(80vw, 320px);
                max-width: 100%;
                height: 100%;
                overflow-y: auto;
                box-shadow: 0 0 20px rgba(0, 0, 0, 0.4);
                background: #222;
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
            }

            .sidebar {
                left: 0;
                transform: translateX(-100%);
            }

            .artifacts-panel {
                right: 0;
                transform: translateX(100%);
            }

            body.show-left-sidebar .sidebar {
                transform: translateX(0);
            }

            body.show-right-sidebar .artifacts-panel {
                transform: translateX(0);
            }

            body.sidebar-open {
                overflow: hidden;
            }

            .mobile-overlay {
                display: block;
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.5);
                opacity: 0;
                pointer-events: none;
                transition: opacity 0.3s ease;
                z-index: 10;
            }

            body.sidebar-open .mobile-overlay {
                opacity: 1;
                pointer-events: auto;
            }

            .sidebar-close-btn,
            .artifacts-close-btn {
                display: inline-flex;
                align-items: center;
                justify-content: center;
                width: 32px;
                height: 32px;
                border-radius: 50%;
                background: rgba(0, 0, 0, 0.4);
            }

            .mobile-toolbar {
                display: flex;
            }

            .chat-header {
                max-height: unset;
                overflow: visible;
            }

            .main-content {
                height: 100%;
                padding-top: env(safe-area-inset-top);
            }

            .chat-area {
                max-height: 100%;
            }

            body.sidebar-open .main-content {
                filter: blur(1px);
            }

            .messages-container {
                padding: 16px;
            }

            .message.user .message-content,
            .message.assistant .message-content {
                max-width: 100%;
            }

            .input-form {
                flex-direction: column;
            }

            .send-btn {
                width: 100%;
            }
        }

        @media (max-width: 600px) {
            .chat-header h2 {
                font-size: 18px;
                padding: 12px 16px;
            }

            .chat-header .mobile-header-toggle,
            .input-area .mobile-input-toggle {
                display: flex;
            }

            .chat-header .mobile-header-toggle {
                margin-bottom: 12px;
            }

            .chat-header.collapsed .mobile-header-toggle {
                margin-bottom: 0;
            }

            .input-area {
                padding: 16px;
                /* AndroidãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ï¼ˆé€šå¸¸48pxç¨‹åº¦ï¼‰+ Safe Areaå¯¾å¿œï¼ˆCSSå¤‰æ•°ã§ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰å¯èƒ½ï¼‰ */
                padding-bottom: max(60px, calc(36px + var(--sab, env(safe-area-inset-bottom, 0px))));
            }

            .input-area.collapsed {
                padding-bottom: max(60px, calc(36px + var(--sab, env(safe-area-inset-bottom, 0px))));
            }

            .message-content {
                font-size: 14px;
            }

            .mobile-toggle-btn {
                font-size: 13px;
            }

            .message-input {
                min-height: 110px;
                /* safe-areaã‚’è€ƒæ…®ã—ãŸæœ€å¤§é«˜ã•ï¼ˆCSSå¤‰æ•°ã§ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰å¯èƒ½ï¼‰ */
                max-height: calc(50vh - var(--sat, env(safe-area-inset-top, 0px)) - var(--sab, env(safe-area-inset-bottom, 0px)));
                max-height: calc(50dvh - var(--sat, env(safe-area-inset-top, 0px)) - var(--sab, env(safe-area-inset-bottom, 0px)));
            }

            .system-prompt-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 6px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å·¦ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼šã‚¹ãƒ¬ãƒƒãƒ‰ä¸€è¦§ -->
        <div class="sidebar" id="leftSidebar">
            <button class="sidebar-collapse-btn" onclick="toggleSidebarCollapse('left')" aria-label="ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’æŠ˜ã‚ŠãŸãŸã‚€">
                <span id="leftSidebarCollapseIcon">â€¹</span>
            </button>
            <div class="sidebar-header">
                <button class="sidebar-close-btn" onclick="closeSidebars()" aria-label="ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’é–‰ã˜ã‚‹">âœ•</button>
                <h1>OpenAI API UI</h1>
                <button class="new-thread-btn" onclick="showNewThreadModal()">+ æ–°è¦ã‚¹ãƒ¬ãƒƒãƒ‰</button>

                <!-- ä½¿ç”¨çŠ¶æ³ã¾ã¨ã‚ãƒ‘ãƒãƒ« -->
                <div class="stats-wrapper">
                    <div class="token-usage-title">
                        <span>ä½¿ç”¨çŠ¶æ³</span>
                        <button class="panel-toggle-btn" onclick="togglePanel('stats')" aria-label="ä½¿ç”¨çŠ¶æ³ãƒ‘ãƒãƒ«ã‚’æŠ˜ã‚ŠãŸãŸã‚€">
                            <span id="statsToggleIcon">â–¼</span>
                        </button>
                    </div>

                    <div class="collapsible-panel" id="statsContent">
                        <!-- ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡ -->
                        <div class="token-usage-panel" id="tokenUsagePanel">
                            <div class="token-usage-title">ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡ (24h)</div>
                            <div class="token-usage-item">
                                <div class="token-usage-label">High Cost Models (1M/day)</div>
                                <div class="token-usage-bar">
                                    <div id="highCostBar" class="token-usage-fill" style="width: 0%"></div>
                                </div>
                                <div class="token-usage-text">
                                    <span id="highCostUsage">0</span>
                                    <span id="highCostPercent">0%</span>
                                </div>
                            </div>

                            <div class="token-usage-item">
                                <div class="token-usage-label">Low Cost Models (10M/day)</div>
                                <div class="token-usage-bar">
                                    <div id="lowCostBar" class="token-usage-fill" style="width: 0%"></div>
                                </div>
                                <div class="token-usage-text">
                                    <span id="lowCostUsage">0</span>
                                    <span id="lowCostPercent">0%</span>
                                </div>
                            </div>
                        </div>

                        <!-- ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆæ®‹é«˜ -->
                        <div class="token-usage-panel" id="creditPanel">
                            <div class="token-usage-title">ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆæ®‹é«˜</div>
                            <div class="token-usage-item">
                                <div class="token-usage-label">æ®‹ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ</div>
                                <div class="token-usage-bar">
                                    <div id="creditBar" class="token-usage-fill" style="width: 0%"></div>
                                </div>
                                <div class="token-usage-text">
                                    <span id="creditAmount">0</span>
                                    <span id="creditText"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="threadsList" class="threads-list"></div>
        </div>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼šãƒãƒ£ãƒƒãƒˆ -->
        <div class="main-content">
            <div class="chat-header">
                <button
                    class="mobile-header-toggle"
                    id="mobileHeaderToggle"
                    type="button"
                    onclick="toggleMobileHeader()"
                    aria-label="ãƒãƒ£ãƒƒãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ã‚’é–‹é–‰"
                    aria-expanded="false"
                >
                    <span class="toggle-icon">â˜°</span>
                    <span class="toggle-label">ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’é–‹ã</span>
                </button>
                <div class="chat-header-content">
                    <div class="mobile-toolbar">
                        <button class="mobile-toggle-btn" onclick="toggleLeftSidebar()" aria-label="ã‚¹ãƒ¬ãƒƒãƒ‰ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’é–‹ã">
                            <span>â˜°</span>
                            <span>ã‚¹ãƒ¬ãƒƒãƒ‰</span>
                        </button>
                        <button class="mobile-toggle-btn" onclick="toggleRightSidebar()" aria-label="ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’é–‹ã">
                            <span>ğŸ“</span>
                            <span>ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆ</span>
                        </button>
                    </div>
                    <h2 id="chatTitle">ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„</h2>
                    <!-- ãƒ¢ãƒ‡ãƒ«ç®¡ç†ã‚«ãƒ¼ãƒ‰ -->
                    <div class="model-selector" id="modelSelector" style="display: none;">
                        <label for="modelSelect">ãƒ¢ãƒ‡ãƒ«:</label>
                        <select id="modelSelect" onchange="changeModel()"></select>
                    </div>
                    <!-- ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç®¡ç†ã‚«ãƒ¼ãƒ‰ -->
                    <div class="system-prompt-header">
                        <div class="system-prompt-controls">
                            <span id="systemPromptStatus" class="system-prompt-status">ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ è‡ªå‹•åŒæœŸä¸­</span>
                            <button class="system-prompt-toggle" onclick="toggleSystemPromptPanel()">è¡¨ç¤º/éè¡¨ç¤º</button>
                        </div>
                    </div>
                    <div id="systemPromptWrapper" class="system-prompt-wrapper hidden">
                        <div id="systemPromptPanel" class="system-prompt-panel">
                            <label class="form-label">ãƒ¦ãƒ¼ã‚¶ãƒ¼ç·¨é›†å¯èƒ½ãªãƒ™ãƒ¼ã‚¹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ</label>
                            <textarea id="systemPromptUserInput" class="form-textarea system-prompt-textarea" spellcheck="false"></textarea>
                            <div class="system-prompt-actions">
                                <button id="systemPromptSaveBtn" class="btn btn-primary" onclick="saveSystemPrompt()" disabled>ä¿å­˜</button>
                                <button class="btn btn-secondary" onclick="refreshSystemPrompt()" disabled>å†èª­ã¿è¾¼ã¿</button>
                            </div>
                            <div class="system-prompt-section">
                                <div class="system-prompt-section-title">è‡ªå‹•é€£æºã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆä¸€è¦§ (JSON)</div>
                                <pre><code id="systemPromptAutoPreview">{}</code></pre>
                            </div>
                            <div class="system-prompt-section">
                                <div class="system-prompt-section-title">é€ä¿¡æ™‚ã«åˆ©ç”¨ã•ã‚Œã‚‹ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ</div>
                                <pre><code id="systemPromptEffectivePreview"></code></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="chatArea" class="chat-area hidden">
                <div id="messagesContainer" class="messages-container"></div>
                <div class="input-area">
                    <button
                        class="mobile-input-toggle"
                        id="mobileInputToggle"
                        type="button"
                        onclick="toggleMobileInput()"
                        aria-label="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¥åŠ›æ¬„ã‚’é–‹é–‰"
                        aria-expanded="false"
                    >
                        <span class="toggle-icon">âœ‰ï¸</span>
                        <span class="toggle-label">å…¥åŠ›æ¬„ã‚’é–‹ã</span>
                    </button>
                    <div class="input-area-content">
                        <form class="input-form" onsubmit="sendMessage(event)">
                            <div class="input-wrapper">
                                <div class="resize-handle" id="resizeHandle"></div>
                                <textarea
                                    id="messageInput"
                                    class="message-input"
                                    placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›... (Shift+Enterã§é€ä¿¡)"
                                    onkeydown="handleInputKeydown(event)"
                                ></textarea>
                            </div>
                            <button id="sendBtn" type="submit" class="send-btn">é€ä¿¡</button>
                        </form>
                    </div>
                </div>
            </div>

            <div id="emptyState" class="empty-state">
                <div class="empty-state-icon">ğŸ’¬</div>
                <div class="empty-state-text">
                    æ–°ã—ã„ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ä½œæˆã™ã‚‹ã‹ã€<br>æ—¢å­˜ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„
                </div>
            </div>
        </div>

        <div class="mobile-overlay" id="mobileOverlay" onclick="closeSidebars()"></div>

        <!-- å³ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼šã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆ -->
        <div class="artifacts-panel" id="rightSidebar">
            <button class="artifacts-collapse-btn" onclick="toggleSidebarCollapse('right')" aria-label="ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’æŠ˜ã‚ŠãŸãŸã‚€">
                <span id="rightSidebarCollapseIcon">â€º</span>
            </button>
            <div class="artifacts-header">
                <button class="artifacts-close-btn" onclick="closeSidebars()" aria-label="ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’é–‰ã˜ã‚‹">âœ•</button>
                <h3>ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆ</h3>
                <button class="create-artifact-btn" onclick="showCreateArtifactModal()" id="createArtifactBtn" disabled>+ æ–°è¦ä½œæˆ</button>
                <div id="artifactDropzone" class="artifact-dropzone">
                    <span id="artifactDropzoneLabel">ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆUTF-8ï¼‰ã®ã¿å¯¾å¿œ: ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã“ã“ã«ãƒ‰ãƒ­ãƒƒãƒ—ï¼ˆã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ï¼‰</span>
                    <input id="artifactFileInput" type="file" multiple hidden />
                </div>
            </div>
            <div class="artifacts-list" id="artifactsList">
                <div style="padding: 20px; text-align: center; color: #666;">èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>
        </div>
    </div>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ç¾¤ -->
    <div id="newThreadModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">æ–°è¦ã‚¹ãƒ¬ãƒƒãƒ‰ä½œæˆ</div>
            <form onsubmit="createThread(event)">
                <div class="form-group">
                    <label class="form-label">ã‚¿ã‚¤ãƒˆãƒ«</label>
                    <input type="text" id="threadTitle" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">ãƒ¢ãƒ‡ãƒ«</label>
                    <select id="threadModel" class="form-select"></select>
                </div>
                <div class="form-group">
                    <label class="form-label">ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ</label>
                    <textarea id="threadSystemPrompt" class="form-textarea">You are a helpful assistant.</textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('newThreadModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="submit" class="btn btn-primary">ä½œæˆ</button>
                </div>
            </form>
        </div>
    </div>

    <div id="editPromptModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç·¨é›†</div>
            <form onsubmit="updateSystemPrompt(event)">
                <div class="form-group">
                    <label class="form-label">ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ</label>
                    <textarea id="editSystemPrompt" class="form-textarea"></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('editPromptModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                </div>
            </form>
            <div class="thread-delete-container">
                <button class="delete-thread-btn" onclick="deleteCurrentThread()">ã“ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’å‰Šé™¤</button>
            </div>
        </div>
    </div>

    <div id="artifactModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header" id="artifactModalTitle">ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆ</div>
            <div class="form-group">
                <pre><code id="artifactContent"></code></pre>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-primary" onclick="editCurrentArtifact()">ç·¨é›†</button>
                <button type="button" class="btn btn-primary" onclick="downloadCurrentArtifact()">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal('artifactModal')">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <div id="createArtifactModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’ä½œæˆ</div>
            <form onsubmit="createArtifact(event)">
                <div class="form-group">
                    <label class="form-label">ãƒ•ã‚¡ã‚¤ãƒ«åï¼ˆãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ï¼‰</label>
                    <input type="text" class="form-input" id="artifactFilename" placeholder="example.js" required>
                </div>
                <div class="form-group">
                    <label class="form-label">ã‚³ãƒ³ãƒ†ãƒ³ãƒ„</label>
                    <textarea class="form-textarea" id="artifactContentInput" style="min-height: 300px; font-family: monospace;" required></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">èª¬æ˜ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</label>
                    <input type="text" class="form-input" id="artifactDescription">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('createArtifactModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="submit" class="btn btn-primary">ä½œæˆ</button>
                </div>
            </form>
        </div>
    </div>

    <div id="editArtifactModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’ç·¨é›†</div>
            <form onsubmit="saveArtifactEdit(event)">
                <div class="form-group">
                    <label class="form-label">ãƒ•ã‚¡ã‚¤ãƒ«å</label>
                    <input type="text" class="form-input" id="editArtifactFilename" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">ã‚³ãƒ³ãƒ†ãƒ³ãƒ„</label>
                    <textarea class="form-textarea" id="editArtifactContent" style="min-height: 300px; font-family: monospace;" required></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">èª¬æ˜ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</label>
                    <input type="text" class="form-input" id="editArtifactDescription">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('editArtifactModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ====================
        // èªè¨¼æ©Ÿèƒ½
        // ====================
        
        // ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—
        function getAuthToken() {
            return localStorage.getItem('authToken');
        }

        // èªè¨¼ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’å–å¾—
        function getAuthHeaders() {
            const token = getAuthToken();
            if (!token) {
                return {};
            }
            return {
                'Authorization': `Bearer ${token}`
            };
        }

        // èªè¨¼ä»˜ãfetchï¼ˆå…¨ã¦ã®APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ä½¿ç”¨ï¼‰
        async function authFetch(url, options = {}) {
            const authHeaders = getAuthHeaders();
            const headers = {
                ...authHeaders,
                ...(options.headers || {})
            };
            
            return fetch(url, {
                ...options,
                headers
            });
        }

        // èªè¨¼ãƒã‚§ãƒƒã‚¯
        async function checkAuth() {
            const token = getAuthToken();
            
            if (!token) {
                redirectToLogin();
                return false;
            }

            try {
                const response = await authFetch('./api/auth/me', {
                    headers: getAuthHeaders()
                });

                if (!response.ok) {
                    throw new Error('Authentication failed');
                }

                const data = await response.json();
                console.log('Logged in as:', data.user.user_id);
                
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¡¨ç¤ºï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
                updateUserInfo(data.user);
                
                return true;
            } catch (error) {
                console.error('Auth check failed:', error);
                redirectToLogin();
                return false;
            }
        }

        // ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
        function redirectToLogin() {
            const currentUrl = encodeURIComponent(window.location.pathname + window.location.search);
            window.location.href = `./login.html?return=${currentUrl}`;
        }

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        function logout() {
            if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                localStorage.removeItem('authToken');
                localStorage.removeItem('userId');
                redirectToLogin();
            }
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¡¨ç¤º
        function updateUserInfo(user) {
            // statsContentå†…ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¿½åŠ 
            const statsContent = document.getElementById('statsContent');
            if (statsContent && !document.getElementById('userInfo')) {
                const userInfoDiv = document.createElement('div');
                userInfoDiv.id = 'userInfo';
                userInfoDiv.className = 'token-usage-panel';

                userInfoDiv.innerHTML = `
                    <div class="token-usage-title">ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±</div>
                    <div style="color: #999; margin-bottom: 4px; font-size: 12px;">ãƒ­ã‚°ã‚¤ãƒ³ä¸­</div>
                    <div style="color: #e0e0e0; font-weight: 500; margin-bottom: 8px; font-size: 12px;">${user.user_id}</div>
                    <button onclick="logout()" style="width: 100%; padding: 6px; background: #444; border: none; border-radius: 4px; color: #e0e0e0; cursor: pointer; font-size: 12px;">
                        ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                    </button>
                `;

                statsContent.appendChild(userInfoDiv);
            }
        }

        // 401ã‚¨ãƒ©ãƒ¼ã®ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
        function handleUnauthorized() {
            console.warn('Unauthorized access detected');
            localStorage.removeItem('authToken');
            localStorage.removeItem('userId');
            redirectToLogin();
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«fetchã‚’ãƒ©ãƒƒãƒ—ï¼ˆèªè¨¼ãŒå¿…è¦ãªAPIãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ã¿ï¼‰
        const originalFetch = window.fetch;
        
        // fetchã®ãƒ©ãƒƒãƒ‘ãƒ¼é–¢æ•°ï¼ˆèªè¨¼ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è‡ªå‹•è¿½åŠ ï¼‰
        async function authenticatedFetch(url, options = {}) {
            const authHeaders = getAuthHeaders();
            const headers = {
                ...authHeaders,
                ...(options.headers || {})
            };

            // fetch()ã§ã¯ãªãoriginalFetch()ã‚’ä½¿ç”¨
            const response = await originalFetch(url, {
                ...options,
                headers
            });

            // 401ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
            if (response.status === 401) {
                handleUnauthorized();
                throw new Error('Unauthorized');
            }

            return response;
        }

        // window.fetchã‚’ä¸Šæ›¸ã
        window.fetch = async function(url, options = {}) {
            // ç›¸å¯¾URLã¾ãŸã¯åŒã˜ã‚ªãƒªã‚¸ãƒ³ã®APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å ´åˆã¯èªè¨¼ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¿½åŠ 
            if (typeof url === 'string' && (url.startsWith('./api/') || url.startsWith('/api/'))) {
                try {
                    return await authenticatedFetch(url, options);
                } catch (error) {
                    // èªè¨¼ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯ã‚¨ãƒ©ãƒ¼ã‚’ã‚¹ãƒ­ãƒ¼ï¼ˆå‘¼ã³å‡ºã—å´ã§ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¯èƒ½ã«ï¼‰
                    throw error;
                }
            }
            // ãã‚Œä»¥å¤–ã¯é€šå¸¸ã®fetch
            return originalFetch(url, options);
        };

        // ====================
        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³æœ¬ä½“
        // ====================
        
        const ALLOWED_TEXT_EXTENSIONS = new Set([
            '.txt', '.md', '.markdown', '.json', '.json5', '.js', '.mjs', '.cjs', '.ts', '.tsx',
            '.jsx', '.css', '.scss', '.sass', '.less', '.html', '.htm', '.xml', '.svg', '.yml', '.yaml',
            '.csv', '.tsv', '.log', '.ini', '.cfg', '.conf', '.env', '.py', '.rb', '.go', '.java', '.kt',
            '.swift', '.c', '.h', '.hpp', '.cpp', '.cc', '.cs', '.rs', '.php', '.sql', '.sh', '.bash', '.zsh', '.ps1'
        ]);
        const DROPZONE_TEXT_DEFAULT = 'ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆUTF-8ï¼‰ã®ã¿å¯¾å¿œ: ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã“ã“ã«ãƒ‰ãƒ­ãƒƒãƒ—ï¼ˆã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ï¼‰';
        const ALLOWED_TEXT_EXTENSIONS_MESSAGE = Array.from(ALLOWED_TEXT_EXTENSIONS).sort().join(', ');

        let currentThreadId = null;
        let availableModels = [];
        let currentArtifact = null;
        let systemPromptState = {
            user: '',
            effective: '',
            artifacts: []
        };
        let isUploadingArtifacts = false;
        let artifactDropzoneUpdater = null;
        const MOBILE_BREAKPOINT = 600;
        let isMobileViewport = null;

        function initResizeHandle() {
            const resizeHandle = document.getElementById('resizeHandle');
            const messageInput = document.getElementById('messageInput');
            if (!resizeHandle || !messageInput) return;

            let isResizing = false;
            let startY = 0;
            let startHeight = 0;

            // safe-areaã‚’è€ƒæ…®ã—ãŸæœ€å¤§é«˜ã•ã‚’è¨ˆç®—ã™ã‚‹é–¢æ•°
            function getMaxInputHeight() {
                // containerã®å®Ÿéš›ã®é«˜ã•ã‚’ä½¿ç”¨ï¼ˆsafe-areaãŒè€ƒæ…®ã•ã‚Œã¦ã„ã‚‹ï¼‰
                const container = document.querySelector('.container');
                const containerHeight = container ? container.clientHeight : window.innerHeight;

                // ãƒ¢ãƒã‚¤ãƒ«ã‹ã©ã†ã‹ã‚’åˆ¤å®š
                const isMobile = window.innerWidth <= 768;
                const maxHeightRatio = isMobile ? 0.5 : 0.6;

                return containerHeight * maxHeightRatio;
            }

            resizeHandle.addEventListener('mousedown', (e) => {
                isResizing = true;
                startY = e.clientY;
                startHeight = messageInput.offsetHeight;
                document.body.style.cursor = 'ns-resize';
                document.body.style.userSelect = 'none';
                e.preventDefault();
            });

            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;

                // ä¸Šã«ãƒ‰ãƒ©ãƒƒã‚°ã™ã‚‹ã¨å¤§ãããªã‚‹ï¼ˆãƒã‚¤ãƒŠã‚¹æ–¹å‘ï¼‰
                const deltaY = startY - e.clientY;
                const newHeight = startHeight + deltaY;

                // min-heightã¨max-heightã®åˆ¶ç´„ã‚’é©ç”¨
                const minHeight = 120;
                const maxHeight = getMaxInputHeight();
                const constrainedHeight = Math.max(minHeight, Math.min(maxHeight, newHeight));

                messageInput.style.flex = 'none';
                messageInput.style.height = constrainedHeight + 'px';
            });

            document.addEventListener('mouseup', () => {
                if (isResizing) {
                    isResizing = false;
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                }
            });

            // ã‚¿ãƒƒãƒãƒ‡ãƒã‚¤ã‚¹å¯¾å¿œ
            resizeHandle.addEventListener('touchstart', (e) => {
                isResizing = true;
                startY = e.touches[0].clientY;
                startHeight = messageInput.offsetHeight;
                e.preventDefault();
            }, { passive: false });

            document.addEventListener('touchmove', (e) => {
                if (!isResizing) return;

                const deltaY = startY - e.touches[0].clientY;
                const newHeight = startHeight + deltaY;

                const minHeight = 120;
                const maxHeight = getMaxInputHeight();
                const constrainedHeight = Math.max(minHeight, Math.min(maxHeight, newHeight));

                messageInput.style.flex = 'none';
                messageInput.style.height = constrainedHeight + 'px';
            }, { passive: false });

            document.addEventListener('touchend', () => {
                if (isResizing) {
                    isResizing = false;
                }
            });
        }

        async function init() {
            // èªè¨¼ãƒã‚§ãƒƒã‚¯ï¼ˆæœ€åˆã«å®Ÿè¡Œï¼‰
            const isAuthenticated = await checkAuth();
            if (!isAuthenticated) {
                return; // èªè¨¼å¤±æ•—æ™‚ã¯ã“ã“ã§çµ‚äº†ï¼ˆãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã‚‹ï¼‰
            }

            await loadThreads();
            await loadModels();
            await loadTokenUsage();
            await loadCreditInfo(); // ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆæƒ…å ±ã‚’åˆå›èª­ã¿è¾¼ã¿
            await loadArtifacts();
            setInterval(loadTokenUsage, 30000); // 30ç§’ã”ã¨ã«ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡ã‚’æ›´æ–°
            setInterval(loadCreditInfo, 30000); // 30ç§’ã”ã¨ã«ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆæƒ…å ±ã‚’æ›´æ–°

            artifactDropzoneUpdater = initArtifactDropzone();
            handleResponsiveSidebarState();
            handleMobileFoldState({ forceCollapse: true });
            initResizeHandle();
            window.addEventListener('resize', () => {
                handleResponsiveSidebarState();
                handleMobileFoldState();
            });
        }

        async function loadModels() {
            try {
                const response = await authFetch('./api/models');
                const data = await response.json();
                availableModels = data.availableModels;
                
                const modelSelect = document.getElementById('modelSelect');
                const threadModelSelect = document.getElementById('threadModel');
                
                data.availableModels.forEach(model => {
                    const isHighCost = data.highCostModels.includes(model);
                    const optionText = `${model}${isHighCost ? ' (1M/day)' : ' (10M/day)'}`;
                    
                    const option1 = document.createElement('option');
                    option1.value = model;
                    option1.textContent = optionText;
                    modelSelect.appendChild(option1);
                    
                    const option2 = document.createElement('option');
                    option2.value = model;
                    option2.textContent = optionText;
                    if (model === data.defaultModel) option2.selected = true;
                    threadModelSelect.appendChild(option2);
                });
            } catch (error) {
                console.error('Failed to load models:', error);
            }
        }

        async function loadTokenUsage() {
            try {
                const response = await authFetch('./api/token-usage/stats');
                const data = await response.json();
                
                const highCostUsage = data.last24Hours.highCost.usage;
                const highCostLimit = data.last24Hours.highCost.limit;
                const highCostPercent = parseFloat(data.last24Hours.highCost.percentage);
                
                document.getElementById('highCostUsage').textContent = 
                    `${formatTokens(highCostUsage)} / ${formatTokens(highCostLimit)}`;
                document.getElementById('highCostPercent').textContent = 
                    `${highCostPercent.toFixed(1)}%`;
                
                const highCostBar = document.getElementById('highCostBar');
                highCostBar.style.width = `${Math.min(highCostPercent, 100)}%`;
                highCostBar.className = 'token-usage-fill';
                if (highCostPercent >= 90) highCostBar.classList.add('danger');
                else if (highCostPercent >= 70) highCostBar.classList.add('warning');
                
                const lowCostUsage = data.last24Hours.lowCost.usage;
                const lowCostLimit = data.last24Hours.lowCost.limit;
                const lowCostPercent = parseFloat(data.last24Hours.lowCost.percentage);
                
                document.getElementById('lowCostUsage').textContent = 
                    `${formatTokens(lowCostUsage)} / ${formatTokens(lowCostLimit)}`;
                document.getElementById('lowCostPercent').textContent = 
                    `${lowCostPercent.toFixed(1)}%`;
                
                const lowCostBar = document.getElementById('lowCostBar');
                lowCostBar.style.width = `${Math.min(lowCostPercent, 100)}%`;
                lowCostBar.className = 'token-usage-fill';
                if (lowCostPercent >= 90) lowCostBar.classList.add('danger');
                else if (lowCostPercent >= 70) lowCostBar.classList.add('warning');
            } catch (error) {
                console.error('Failed to load token usage:', error);
            }
        }

        function formatTokens(tokens) {
            if (tokens >= 1000000) return (tokens / 1000000).toFixed(2) + 'M';
            if (tokens >= 1000) return (tokens / 1000).toFixed(1) + 'K';
            return tokens.toString();
        }

        // ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆæƒ…å ±ã®èª­ã¿è¾¼ã¿
        let CREDIT_MAX_DISPLAY = 100000; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã€ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å–å¾—
        
        async function loadCreditInfo() {
            try {
                const response = await authFetch('./api/auth/me');
                const data = await response.json();
                
                if (data.user && typeof data.user.remaining_credit === 'number') {
                    updateCreditDisplay(data.user.remaining_credit);
                }
                
                // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰æœ€å¤§è¡¨ç¤ºå€¤ã‚’å–å¾—ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
                if (data.creditMaxDisplay) {
                    CREDIT_MAX_DISPLAY = data.creditMaxDisplay;
                }
            } catch (error) {
                console.error('Failed to load credit info:', error);
            }
        }
        
        // ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆè¡¨ç¤ºã‚’æ›´æ–°ï¼ˆå¯¾æ•°ã‚¹ã‚±ãƒ¼ãƒ«ï¼‰
        function updateCreditDisplay(remainingCredit) {
            const creditAmount = document.getElementById('creditAmount');
            const creditText = document.getElementById('creditText');
            const creditBar = document.getElementById('creditBar');
            
            if (!creditAmount || !creditText || !creditBar) return;
            
            // ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆãŒ0ä»¥ä¸‹ã®å ´åˆã¯ç‰¹åˆ¥ãªè¡¨ç¤º
            if (remainingCredit <= 0) {
                creditAmount.textContent = remainingCredit.toLocaleString();
                creditAmount.style.color = '#ff3333';
                creditAmount.style.fontWeight = 'bold';
                creditAmount.style.fontSize = '14px';
                
                creditText.textContent = 'æ®‹é«˜ä¸è¶³';
                creditText.style.color = '#ff3333';
                creditText.style.fontWeight = 'bold';
                
                creditBar.style.width = '0%';
                creditBar.className = 'token-usage-fill danger';
                return;
            }
            
            // é€šå¸¸ã®è¡¨ç¤ºï¼ˆ0ã‚ˆã‚Šå¤§ãã„å ´åˆï¼‰
            creditAmount.style.color = '#aaa';
            creditAmount.style.fontWeight = 'normal';
            creditAmount.style.fontSize = '11px';
            creditText.style.color = '#aaa';
            creditText.style.fontWeight = 'normal';
            
            // æ•°å€¤ã‚’è¡¨ç¤ºï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰
            creditAmount.textContent = remainingCredit.toLocaleString();
            
            // å¯¾æ•°ã‚¹ã‚±ãƒ¼ãƒ«ã§ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸ã‚’è¨ˆç®—
            const logCredit = Math.log10(remainingCredit);
            const logMax = Math.log10(CREDIT_MAX_DISPLAY);
            let percentage = (logCredit / logMax) * 100;
            percentage = Math.min(Math.max(percentage, 0), 100);
            
            creditText.textContent = ``;
            creditBar.style.width = `${percentage}%`;
            
            // è‰²åˆ†ã‘ï¼ˆæ®‹ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆãŒå°‘ãªã„å ´åˆã«è­¦å‘Šï¼‰
            creditBar.className = 'token-usage-fill';
            if (remainingCredit < 1000) {
                creditBar.classList.add('danger');
            } else if (remainingCredit < 5000) {
                creditBar.classList.add('warning');
            }
        }

        async function changeModel() {
            if (!currentThreadId) return;
            const model = document.getElementById('modelSelect').value;
            
            try {
                await authFetch(`./api/threads/${currentThreadId}/model`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model })
                });
                console.log(`Model changed to: ${model}`);
            } catch (error) {
                console.error('Failed to change model:', error);
                alert('ãƒ¢ãƒ‡ãƒ«ã®å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        async function loadThreads() {
            try {
                const response = await authFetch('./api/threads');
                const data = await response.json();
                const threadsList = document.getElementById('threadsList');
                
                if (data.threads.length === 0) {
                    threadsList.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">ã‚¹ãƒ¬ãƒƒãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                    return;
                }
                
                threadsList.innerHTML = data.threads
                    .sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt))
                    .map(thread => `
                        <div class="thread-item ${thread.id === currentThreadId ? 'active' : ''}" 
                             onclick="loadThread('${thread.id}')">
                            <div class="thread-item-title">${escapeHtml(thread.title)}</div>
                            <div class="thread-item-date">${formatDate(thread.updatedAt)}</div>
                        </div>
                    `).join('');
            } catch (error) {
                console.error('Failed to load threads:', error);
            }
        }

        async function loadThread(threadId) {
            try {
                const response = await authFetch(`./api/threads/${threadId}`);
                
                // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒæ­£å¸¸ã§ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼å‡¦ç†
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Failed to load thread:', errorData.error || 'Unknown error');
                    alert(`ã‚¹ãƒ¬ãƒƒãƒ‰ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${errorData.error || 'Unknown error'}`);
                    return;
                }
                
                const thread = await response.json();
                
                // ã‚¹ãƒ¬ãƒƒãƒ‰ãƒ‡ãƒ¼ã‚¿ã®æ¤œè¨¼
                if (!thread || !thread.messages) {
                    console.error('Invalid thread data:', thread);
                    alert('ã‚¹ãƒ¬ãƒƒãƒ‰ãƒ‡ãƒ¼ã‚¿ãŒä¸æ­£ã§ã™');
                    return;
                }
                
                currentThreadId = threadId;
                document.getElementById('chatTitle').textContent = thread.title;
                document.getElementById('modelSelector').style.display = 'flex';
                document.getElementById('modelSelect').value = thread.model || availableModels[0];
                document.getElementById('createArtifactBtn').disabled = false;
                document.getElementById('emptyState').style.display = 'none';
                document.getElementById('chatArea').classList.remove('hidden');
                
                applySystemPromptData({
                    systemPromptUser: thread.systemPromptUser,
                    systemPrompt: thread.systemPrompt,
                    artifactInventory: thread.artifactInventory
                });

                const messagesContainer = document.getElementById('messagesContainer');
                messagesContainer.innerHTML = '';
                
                thread.messages.forEach(msg => {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `message ${msg.role}`;
                    
                    const headerDiv = document.createElement('div');
                    headerDiv.className = 'message-header';
                    headerDiv.textContent = msg.role === 'user' ? 'You' : 'Assistant';
                    
                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'message-content';
                    contentDiv.innerHTML = formatMarkdownText(msg.content);
                    
                    const timestampDiv = document.createElement('div');
                    timestampDiv.className = 'message-timestamp';
                    timestampDiv.textContent = formatDateTime(msg.timestamp);
                    
                    messageDiv.appendChild(headerDiv);
                    messageDiv.appendChild(contentDiv);
                    messageDiv.appendChild(timestampDiv);
                    messagesContainer.appendChild(messageDiv);
                });
                
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                await loadThreads();
                await loadArtifacts();
                artifactDropzoneUpdater?.(); // ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ã®è¡¨ç¤ºçŠ¶æ…‹ã‚’æ›´æ–°

                if (window.innerWidth <= 1024) {
                    closeSidebars();
                }
                updateMobileToggleIndicators();
            } catch (error) {
                console.error('Failed to load thread:', error);
                alert(`ã‚¹ãƒ¬ãƒƒãƒ‰ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`);
            }
        }
        
        function formatMarkdownText(text) {
            if (!text) return '';

            let escaped = escapeHtml(text);
            const codeBlocks = [];

            // 1. ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã‚’ä¸€æ™‚çš„ã«ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã¸
            escaped = escaped.replace(/```([\s\S]*?)```/g, (_, code) => {
                const placeholder = `%%CODEBLOCK_${codeBlocks.length}%%`;
                codeBlocks.push(code);
                return placeholder;
            });

            // 2. è¦‹å‡ºã—ï¼ˆ#ã€œ#####ï¼‰ã‚’è£…é£¾
            escaped = escaped.replace(/(^|\n)(#{1,5})([^\n]*)/g, (match, pre, hashes, content) => {
                const level = Math.min(hashes.length, 5);
                return `${pre}<span class="markdown-heading level-${level}">${hashes}${content}</span>`;
            });

            // 3. å¤ªå­—ï¼ˆ**bold**ï¼‰ã‚’è£…é£¾
            escaped = escaped.replace(/\*\*(.+?)\*\*/g, '<span class="markdown-bold">**$1**</span>');

            // 4. ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã‚’å…ƒã«æˆ»ã—ã¦è£…é£¾
            codeBlocks.forEach((code, index) => {
                const placeholder = `%%CODEBLOCK_${index}%%`;
                escaped = escaped.replace(
                    placeholder,
                    `<span class="markdown-codeblock">\`\`\`${code}\`\`\`</span>`
                );
            });

            return escaped;
        }

        function showNewThreadModal() {
            document.getElementById('newThreadModal').classList.add('active');
            document.getElementById('threadTitle').value = '';
        }

        async function createThread(event) {
            event.preventDefault();
            const title = document.getElementById('threadTitle').value;
            const model = document.getElementById('threadModel').value;
            const systemPrompt = document.getElementById('threadSystemPrompt').value;
            
            try {
                const response = await authFetch('./api/threads', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, model, systemPrompt })
                });
                
                const thread = await response.json();
                closeModal('newThreadModal');
                await loadThreads();
                await loadThread(thread.id);
            } catch (error) {
                console.error('Failed to create thread:', error);
                alert('ã‚¹ãƒ¬ãƒƒãƒ‰ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        async function deleteCurrentThread() {
            if (!currentThreadId || !confirm('ã“ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹?')) return;
            
            try {
                await authFetch(`./api/threads/${currentThreadId}`, { method: 'DELETE' });
                closeModal('editPromptModal');
                currentThreadId = null;
                document.getElementById('chatTitle').textContent = 'ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„';
                document.getElementById('modelSelector').style.display = 'none';
                document.getElementById('createArtifactBtn').disabled = true;
                document.getElementById('emptyState').style.display = 'flex';
                document.getElementById('chatArea').classList.add('hidden');
                await loadThreads();
                await loadArtifacts();
                artifactDropzoneUpdater?.(); // ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ã®è¡¨ç¤ºçŠ¶æ…‹ã‚’æ›´æ–°
            } catch (error) {
                console.error('Failed to delete thread:', error);
                alert('ã‚¹ãƒ¬ãƒƒãƒ‰ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        function toggleSystemPromptPanel() {
            const panel = document.getElementById('systemPromptWrapper');
            panel.classList.toggle('hidden');
        }

        function applySystemPromptData(data) {
            systemPromptState.user = data.systemPromptUser || '';
            systemPromptState.effective = data.systemPrompt || '';
            systemPromptState.artifacts = data.artifactInventory || [];

            const userInput = document.getElementById('systemPromptUserInput');
            const autoPreview = document.getElementById('systemPromptAutoPreview');
            const effectivePreview = document.getElementById('systemPromptEffectivePreview');
            const saveBtn = document.getElementById('systemPromptSaveBtn');
            const refreshBtn = document.querySelector('.system-prompt-actions .btn-secondary');

            if (!userInput) return;

            userInput.value = systemPromptState.user;
            autoPreview.textContent = JSON.stringify(systemPromptState.artifacts, null, 2);
            effectivePreview.textContent = systemPromptState.effective;

            const disabled = !currentThreadId;
            userInput.disabled = disabled;
            saveBtn.disabled = disabled;
            refreshBtn.disabled = disabled;
        }

        async function fetchSystemPrompt() {
            if (!currentThreadId) return;
            try {
                const response = await authFetch(`./api/threads/${currentThreadId}/system-prompt`);
                const data = await response.json();
                applySystemPromptData(data);
            } catch (error) {
                console.error('Failed to fetch system prompt:', error);
            }
        }

        async function saveSystemPrompt() {
            if (!currentThreadId) return;
            try {
                const basePrompt = document.getElementById('systemPromptUserInput').value;
                const response = await authFetch(`./api/threads/${currentThreadId}/system-prompt`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ systemPrompt: basePrompt })
                });
                const data = await response.json();
                applySystemPromptData(data);
                document.getElementById('systemPromptStatus').textContent = 'ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸ (è‡ªå‹•åŒæœŸä¸­)';
            } catch (error) {
                console.error('Failed to save system prompt:', error);
                alert('ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        function getFileExtension(filename = '') {
            const lastDot = filename.lastIndexOf('.');
            if (lastDot === -1) return '';
            return filename.slice(lastDot).toLowerCase();
        }

        function isAllowedTextExtension(filename = '') {
            const ext = getFileExtension(filename);
            if (!ext) return false;
            return ALLOWED_TEXT_EXTENSIONS.has(ext);
        }

        function splitFilesByExtension(files = []) {
            const allowed = [];
            const rejected = [];
            files.forEach((file) => {
                if (isAllowedTextExtension(file.name)) {
                    allowed.push(file);
                } else {
                    rejected.push(file);
                }
            });
            return { allowed, rejected };
        }

        function initArtifactDropzone() {
            const dropzone = document.getElementById('artifactDropzone');
            const fileInput = document.getElementById('artifactFileInput');

            if (!dropzone || !fileInput) return;

            const updateDropzoneState = () => {
                dropzone.classList.toggle('disabled', !currentThreadId || isUploadingArtifacts);
                dropzone.querySelector('#artifactDropzoneLabel').textContent =
                    !currentThreadId ? 'ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„' :
                    isUploadingArtifacts ? 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...' :
                    DROPZONE_TEXT_DEFAULT;
            };

            const highlight = (evt) => {
                evt.preventDefault();
                if (!currentThreadId || isUploadingArtifacts) return;
                dropzone.classList.add('dragover');
            };

            const unhighlight = (evt) => {
                evt.preventDefault();
                dropzone.classList.remove('dragover');
            };

            const handleDrop = (evt) => {
                evt.preventDefault();
                if (!currentThreadId || isUploadingArtifacts) return;
                const files = evt.dataTransfer?.files;
                if (files?.length) {
                    uploadArtifacts(files);
                }
            };

            dropzone.addEventListener('click', () => {
                if (!currentThreadId || isUploadingArtifacts) return;
                fileInput.click();
            });

            dropzone.addEventListener('dragenter', highlight);
            dropzone.addEventListener('dragover', highlight);
            dropzone.addEventListener('dragleave', unhighlight);
            dropzone.addEventListener('drop', (evt) => {
                unhighlight(evt);
                handleDrop(evt);
            });

            fileInput.addEventListener('change', (evt) => {
                const files = evt.target.files;
                if (files?.length) {
                    uploadArtifacts(files);
                    fileInput.value = '';
                }
            });

            updateDropzoneState();

            return updateDropzoneState;
        }

        async function uploadArtifacts(fileList) {
            if (!currentThreadId || isUploadingArtifacts) return;

            const filesArray = Array.isArray(fileList) ? fileList : Array.from(fileList || []);
            if (!filesArray.length) return;

            const { allowed, rejected } = splitFilesByExtension(filesArray);

            if (rejected.length) {
                const rejectedNames = rejected.map(file => `ãƒ»${file.name}`).join('\n');
                alert(`ãƒ†ã‚­ã‚¹ãƒˆä»¥å¤–ã®æ‹¡å¼µå­ã€ã¾ãŸã¯æ‹¡å¼µå­ãŒæœªè¨­å®šã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã›ã‚“ã€‚\nã‚¹ã‚­ãƒƒãƒ—ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:\n${rejectedNames}\n\nå¯¾å¿œã—ã¦ã„ã‚‹æ‹¡å¼µå­:\n${ALLOWED_TEXT_EXTENSIONS_MESSAGE}`);
            }

            if (!allowed.length) {
                return;
            }

            const formData = new FormData();
            formData.append('threadId', currentThreadId);

            const metadataMap = {};
            allowed.forEach((file) => {
                formData.append('files', file);
                metadataMap[file.name] = {
                    description: `Uploaded via UI at ${new Date().toISOString()}`
                };
            });
            formData.append('metadata', JSON.stringify(metadataMap));

            isUploadingArtifacts = true;
            artifactDropzoneUpdater?.();

            const dropzone = document.getElementById('artifactDropzone');
            const artifactsList = document.getElementById('artifactsList');
            const statusLabel = dropzone?.querySelector('#artifactDropzoneLabel');
            const originalLabel = statusLabel?.textContent;

            try {
                statusLabel.textContent = `ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­ (${allowed.length} ãƒ•ã‚¡ã‚¤ãƒ«)...`;
                const response = await authFetch('./api/artifacts/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                const { results = [] } = result;
                if (!response.ok && response.status !== 207) throw new Error('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ');

                const errors = results.filter(item => item.error);
                if (errors.length) {
                    console.warn('ä¸€éƒ¨ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤±æ•—:', errors);
                    alert(`ä¸€éƒ¨ã®ãƒ•ã‚¡ã‚¤ãƒ«ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n${errors.map(err => `${err.originalName}: ${err.error}`).join('\n')}`);
                } else {
                    alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ');
                }

                await Promise.all([
                    loadArtifacts(),
                    fetchSystemPrompt()
                ]);
            } catch (error) {
                console.error('uploadArtifacts error:', error);
                alert(error.message || 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ');
                if (artifactsList) {
                    artifactsList.innerHTML = '<div style="padding: 20px; text-align: center; color: #ff6666;">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>';
                }
            } finally {
                isUploadingArtifacts = false;
                if (statusLabel) statusLabel.textContent = originalLabel;
                artifactDropzoneUpdater?.();
            }
        }

        function showUsageLimitPopup() {
            alert('ãã‚ãã‚24hã®ç„¡æ–™åˆ©ç”¨æ ã‚’è¶…ãˆã‚‹ã®ã§ã€ã—ã°ã‚‰ãå¾…ã£ã¦ã­ï¼');
        }

        async function sendMessage(event) {
            event.preventDefault();
            if (!currentThreadId) return;

            const input = document.getElementById('messageInput');
            const content = input.value.trim();
            if (!content) return;

            const sendBtn = document.getElementById('sendBtn');
            const originalText = sendBtn.textContent;
            sendBtn.disabled = true;
            sendBtn.textContent = 'é€ä¿¡ä¸­...';
            input.disabled = true;

            try {
                const response = await authFetch(`./api/threads/${currentThreadId}/messages`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content })
                });

                if (response.status === 429) {
                    try {
                        await response.json();
                    } catch (_) {}
                    showUsageLimitPopup();
                    return;
                }

                if (!response.ok) {
                    let errorData = null;
                    try {
                        errorData = await response.json();
                    } catch (_) {}
                    throw new Error(errorData?.error || 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

                await response.json();
                input.value = '';
                await loadThread(currentThreadId);
                await loadThreads();
                await loadArtifacts();
                artifactDropzoneUpdater?.(); // ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ã®è¡¨ç¤ºçŠ¶æ…‹ã‚’æ›´æ–°
            } catch (error) {
                console.error('Failed to send message:', error);
                alert(`ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = originalText;
                input.disabled = false;
                input.focus();
                await loadTokenUsage();
                await loadCreditInfo(); // ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆæƒ…å ±ã‚’æ›´æ–°
            }
        }

        async function loadArtifacts() {
            try {
                const url = currentThreadId ? `./api/artifacts?threadId=${currentThreadId}` : './api/artifacts';
                const response = await fetch(url);
                const data = await response.json();
                const artifactsList = document.getElementById('artifactsList');
                
                if (data.artifacts.length === 0) {
                    const message = currentThreadId ? 'ã“ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã«ã¯ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆãŒã‚ã‚Šã¾ã›ã‚“' : 'ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆãŒã‚ã‚Šã¾ã›ã‚“';
                    artifactsList.innerHTML = `<div style="padding: 20px; text-align: center; color: #666;">${message}</div>`;
                    return;
                }

                artifactsList.innerHTML = data.artifacts
                    .sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt))
                    .map(artifact => `
                        <div class="artifact-item">
                            <div class="artifact-filename">${escapeHtml(artifact.filename)}</div>
                            <div class="artifact-meta">v${artifact.currentVersion} (${artifact.versionCount} versions)</div>
                            <div class="artifact-meta">${formatDate(artifact.updatedAt)}</div>
                            <div class="artifact-actions">
                                <button class="artifact-btn" onclick="viewArtifact('${artifact.id}')">è¡¨ç¤º</button>
                                <button class="artifact-btn" onclick="downloadArtifact('${artifact.id}')">DL</button>
                                <button class="artifact-btn" style="background: #cc0000;" onclick="deleteArtifact('${artifact.id}')">å‰Šé™¤</button>
                            </div>
                        </div>
                    `).join('');
            } catch (error) {
                console.error('Failed to load artifacts:', error);
            }
        }

        async function viewArtifact(artifactId) {
            try {
                const response = await authFetch(`./api/artifacts/${artifactId}`);
                const artifact = await response.json();
                
                currentArtifact = artifact;
                document.getElementById('artifactModalTitle').textContent = `${artifact.filename} (v${artifact.version})`;
                document.getElementById('artifactContent').textContent = artifact.content;
                document.getElementById('artifactModal').classList.add('active');
            } catch (error) {
                console.error('Failed to view artifact:', error);
                alert('ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã®è¡¨ç¤ºã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        async function downloadArtifact(artifactId) {
            try {
                const response = await authFetch(`./api/artifacts/${artifactId}`);
                const artifact = await response.json();
                
                const blob = new Blob([artifact.content], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = artifact.filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Failed to download artifact:', error);
                alert('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        function downloadCurrentArtifact() {
            if (!currentArtifact) return;
            
            const blob = new Blob([currentArtifact.content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = currentArtifact.filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function showCreateArtifactModal() {
            if (!currentThreadId) {
                alert('ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            document.getElementById('createArtifactModal').classList.add('active');
            document.getElementById('artifactFilename').value = '';
            document.getElementById('artifactContentInput').value = '';
            document.getElementById('artifactDescription').value = '';
        }

        async function createArtifact(event) {
            event.preventDefault();
            if (!currentThreadId) return;

            const filenameInput = document.getElementById('artifactFilename');
            const rawFilename = filenameInput.value.trim();
            const content = document.getElementById('artifactContentInput').value;
            const description = document.getElementById('artifactDescription').value;

            if (!rawFilename) {
                alert('ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                filenameInput.focus();
                return;
            }

            if (!isAllowedTextExtension(rawFilename)) {
                const ext = getFileExtension(rawFilename);
                if (!ext) {
                    alert(`ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®æ‹¡å¼µå­ã‚’ä»˜ã‘ã¦ãã ã•ã„ã€‚\nå¯¾å¿œã—ã¦ã„ã‚‹æ‹¡å¼µå­: ${ALLOWED_TEXT_EXTENSIONS_MESSAGE}`);
                } else {
                    alert(`æ‹¡å¼µå­ã€Œ${ext}ã€ã¯ç¾åœ¨ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\nå¯¾å¿œã—ã¦ã„ã‚‹æ‹¡å¼µå­: ${ALLOWED_TEXT_EXTENSIONS_MESSAGE}`);
                }
                filenameInput.focus();
                return;
            }

            try {
                const response = await authFetch('./api/artifacts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        filename: rawFilename,
                        content,
                        threadId: currentThreadId,
                        metadata: { description: description || '' }
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

                closeModal('createArtifactModal');
                await loadArtifacts();
                artifactDropzoneUpdater?.(); // ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ã®è¡¨ç¤ºçŠ¶æ…‹ã‚’æ›´æ–°
                await fetchSystemPrompt(); 
                alert('ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸ');
            } catch (error) {
                console.error('Failed to create artifact:', error);
                alert(`ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        function editCurrentArtifact() {
            if (!currentArtifact) return;
            
            document.getElementById('editArtifactFilename').value = currentArtifact.filename;
            document.getElementById('editArtifactContent').value = currentArtifact.content;
            document.getElementById('editArtifactDescription').value = currentArtifact.metadata?.description || '';
            
            closeModal('artifactModal');
            document.getElementById('editArtifactModal').classList.add('active');
        }

        async function saveArtifactEdit(event) {
            event.preventDefault();
            if (!currentArtifact) return;

            const content = document.getElementById('editArtifactContent').value;
            const description = document.getElementById('editArtifactDescription').value;

            try {
                const response = await authFetch(`./api/artifacts/${currentArtifact.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        content,
                        metadata: { description: description || '' }
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã®ç·¨é›†ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

                closeModal('editArtifactModal');
                await loadArtifacts();
                artifactDropzoneUpdater?.(); // ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ã®è¡¨ç¤ºçŠ¶æ…‹ã‚’æ›´æ–°
                await fetchSystemPrompt();
                alert('ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’æ›´æ–°ã—ã¾ã—ãŸ');
            } catch (error) {
                console.error('Failed to edit artifact:', error);
                alert(`ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        async function deleteArtifact(artifactId) {
            if (!confirm('ã“ã®ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
            
            try {
                const response = await authFetch(`./api/artifacts/${artifactId}`, { method: 'DELETE' });
                if (!response.ok) throw new Error('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
                
                await loadArtifacts();
                artifactDropzoneUpdater?.(); // ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ã®è¡¨ç¤ºçŠ¶æ…‹ã‚’æ›´æ–°
                await fetchSystemPrompt();
                alert('ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
            } catch (error) {
                console.error('Failed to delete artifact:', error);
                alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function handleInputKeydown(event) {
            if (event.key === 'Enter' && event.shiftKey) {
                event.preventDefault();
                sendMessage(event);
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (minutes < 1) return 'ãŸã£ãŸä»Š';
            if (minutes < 60) return `${minutes}åˆ†å‰`;
            if (hours < 24) return `${hours}æ™‚é–“å‰`;
            if (days < 7) return `${days}æ—¥å‰`;
            return date.toLocaleDateString('ja-JP');
        }

        function formatDateTime(dateString) {
            return new Date(dateString).toLocaleString('ja-JP');
        }

        function toggleLeftSidebar() {
            const isOpen = document.body.classList.toggle('show-left-sidebar');
            if (isOpen) {
                document.body.classList.remove('show-right-sidebar');
            }
            updateSidebarOverlayState();
        }

        function toggleRightSidebar() {
            const isOpen = document.body.classList.toggle('show-right-sidebar');
            if (isOpen) {
                document.body.classList.remove('show-left-sidebar');
            }
            updateSidebarOverlayState();
        }

        function closeSidebars() {
            document.body.classList.remove('show-left-sidebar', 'show-right-sidebar');
            updateSidebarOverlayState();
        }

        function updateSidebarOverlayState() {
            const hasOpen = document.body.classList.contains('show-left-sidebar') || document.body.classList.contains('show-right-sidebar');
            document.body.classList.toggle('sidebar-open', hasOpen);
        }

        function handleResponsiveSidebarState() {
            if (window.innerWidth > 1024) {
                document.body.classList.remove('show-left-sidebar', 'show-right-sidebar', 'sidebar-open');
            }
        }

        function toggleMobileHeader() {
            if (window.innerWidth > MOBILE_BREAKPOINT) return;
            const chatHeader = document.querySelector('.chat-header');
            if (!chatHeader) return;
            chatHeader.classList.toggle('collapsed');
            updateMobileToggleIndicators();
        }

        function toggleMobileInput() {
            if (window.innerWidth > MOBILE_BREAKPOINT) return;
            const inputArea = document.querySelector('.input-area');
            if (!inputArea) return;
            const isCollapsed = inputArea.classList.toggle('collapsed');
            updateMobileToggleIndicators();
            if (!isCollapsed) {
                document.getElementById('messageInput')?.focus();
            }
        }

        function handleMobileFoldState({ forceCollapse = false } = {}) {
            const isMobile = window.innerWidth <= MOBILE_BREAKPOINT;
            const chatHeader = document.querySelector('.chat-header');
            const inputArea = document.querySelector('.input-area');

            if (isMobile) {
                if (forceCollapse || isMobileViewport !== true) {
                    chatHeader?.classList.add('collapsed');
                    inputArea?.classList.add('collapsed');
                }
            } else {
                chatHeader?.classList.remove('collapsed');
                inputArea?.classList.remove('collapsed');
            }

            isMobileViewport = isMobile;
            updateMobileToggleIndicators();
        }

        function updateMobileToggleIndicators() {
            const isMobile = window.innerWidth <= MOBILE_BREAKPOINT;
            const chatHeader = document.querySelector('.chat-header');
            const headerToggle = document.getElementById('mobileHeaderToggle');
            if (chatHeader && headerToggle) {
                const collapsed = chatHeader.classList.contains('collapsed');
                headerToggle.setAttribute('aria-expanded', (!collapsed).toString());
                const headerLabel = headerToggle.querySelector('.toggle-label');
                if (headerLabel) {
                    headerLabel.textContent = collapsed ? 'ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’é–‹ã' : 'ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’é–‰ã˜ã‚‹';
                }
                if (!isMobile) {
                    headerToggle.setAttribute('aria-expanded', 'true');
                }
            }

            const inputArea = document.querySelector('.input-area');
            const inputToggle = document.getElementById('mobileInputToggle');
            if (inputArea && inputToggle) {
                const collapsed = inputArea.classList.contains('collapsed');
                inputToggle.setAttribute('aria-expanded', (!collapsed).toString());
                const inputLabel = inputToggle.querySelector('.toggle-label');
                if (inputLabel) {
                    inputLabel.textContent = collapsed ? 'å…¥åŠ›æ¬„ã‚’é–‹ã' : 'å…¥åŠ›æ¬„ã‚’é–‰ã˜ã‚‹';
                }
                if (!isMobile) {
                    inputToggle.setAttribute('aria-expanded', 'true');
                }
            }
        }

        // ãƒ‘ãƒãƒ«æŠ˜ã‚ŠãŸãŸã¿æ©Ÿèƒ½ï¼ˆãƒ¢ãƒã‚¤ãƒ«ç‰ˆï¼‰
        function togglePanel(panelName) {
            const content = document.getElementById(`${panelName}Content`);
            const icon = document.getElementById(`${panelName}ToggleIcon`);

            if (!content || !icon) return;

            const isCollapsed = content.classList.toggle('collapsed');
            icon.textContent = isCollapsed ? 'â–¶' : 'â–¼';

            // çŠ¶æ…‹ã‚’ä¿å­˜
            localStorage.setItem(`panel_${panelName}_collapsed`, isCollapsed);
        }

        // ã‚µã‚¤ãƒ‰ãƒãƒ¼æŠ˜ã‚ŠãŸãŸã¿æ©Ÿèƒ½ï¼ˆPCç‰ˆï¼‰
        function toggleSidebarCollapse(side) {
            if (side === 'left') {
                const sidebar = document.getElementById('leftSidebar');
                const icon = document.getElementById('leftSidebarCollapseIcon');
                const isCollapsed = sidebar.classList.toggle('collapsed');
                icon.textContent = isCollapsed ? 'â€º' : 'â€¹';
                localStorage.setItem('sidebar_left_collapsed', isCollapsed);
            } else if (side === 'right') {
                const panel = document.getElementById('rightSidebar');
                const icon = document.getElementById('rightSidebarCollapseIcon');
                const isCollapsed = panel.classList.toggle('collapsed');
                icon.textContent = isCollapsed ? 'â€¹' : 'â€º';
                localStorage.setItem('sidebar_right_collapsed', isCollapsed);
            }
        }

        // ãƒ‘ãƒãƒ«çŠ¶æ…‹ã®åˆæœŸåŒ–
        function initPanelStates() {
            const isMobile = window.innerWidth <= 1024;

            // ä½¿ç”¨çŠ¶æ³ãƒ‘ãƒãƒ«ï¼ˆstatsï¼‰ã®æŠ˜ã‚ŠãŸãŸã¿çŠ¶æ…‹ã‚’ç®¡ç†
            const statsContent = document.getElementById('statsContent');
            const statsIcon = document.getElementById('statsToggleIcon');

            if (statsContent && statsIcon) {
                // localStorage ã‹ã‚‰çŠ¶æ…‹ã‚’å–å¾—ã€ã¾ãŸã¯ isMobile ãªã‚‰æŠ˜ã‚ŠãŸãŸã‚€
                const savedState = localStorage.getItem('panel_stats_collapsed');
                const shouldCollapse = savedState !== null ? savedState === 'true' : isMobile;

                if (shouldCollapse) {
                    statsContent.classList.add('collapsed');
                    statsIcon.textContent = 'â–¶';
                } else {
                    statsContent.classList.remove('collapsed');
                    statsIcon.textContent = 'â–¼';
                }
            }

            // PCç‰ˆã‚µã‚¤ãƒ‰ãƒãƒ¼ã®çŠ¶æ…‹ã‚’å¾©å…ƒ
            if (!isMobile) {
                const leftCollapsed = localStorage.getItem('sidebar_left_collapsed') === 'true';
                const rightCollapsed = localStorage.getItem('sidebar_right_collapsed') === 'true';

                if (leftCollapsed) {
                    document.getElementById('leftSidebar')?.classList.add('collapsed');
                    const icon = document.getElementById('leftSidebarCollapseIcon');
                    if (icon) icon.textContent = 'â€º';
                }

                if (rightCollapsed) {
                    document.getElementById('rightSidebar')?.classList.add('collapsed');
                    const icon = document.getElementById('rightSidebarCollapseIcon');
                    if (icon) icon.textContent = 'â€¹';
                }
            }
        }

        init();
        initPanelStates();
        window.addEventListener('resize', initPanelStates);
    </script>
</body>
</html>